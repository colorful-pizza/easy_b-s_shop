<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®¢æˆ·ç®¡ç† - ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >è¿”å›é¦–é¡µ</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <main class="content">
        <div class="content-header">
          <h2>å®¢æˆ·ç®¡ç†</h2>
          <div class="breadcrumb">
            <span>é¦–é¡µ > å®¢æˆ·ç®¡ç†</span>
          </div>
        </div>

        <div class="content-body">
          <!-- æ“ä½œæ  -->
          <div class="action-bar">
            <button class="btn btn-primary" onclick="openCustomerModal()">
              æ–°å¢å®¢æˆ·
            </button>
            <div class="search-container">
              <input
                id="searchInput"
                class="search-input"
                placeholder="æœç´¢å®¢æˆ·åæˆ–ç”µè¯"
                onkeyup="handleSearch()"
              />
              <select
                id="statusFilter"
                class="filter-select"
                onchange="handleFilter()"
              >
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="active">æœ‰æ•ˆ</option>
                <option value="inactive">æ— æ•ˆ</option>
              </select>
            </div>
          </div>

          <!-- æ•°æ®è¡¨æ ¼ -->
          <div class="table-container">
            <table class="data-table" id="customersTable">
              <thead>
                <tr>
                  <th>åç§°</th>
                  <th>ç”µè¯</th>
                  <th>åœ°å€</th>
                  <th>çŠ¶æ€</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>å¤‡æ³¨</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="customersTableBody"></tbody>
            </table>
          </div>

          <!-- åˆ†é¡µ -->
          <div class="pagination-container">
            <div class="page-info"><span id="pageInfo">å…± 0 æ¡è®°å½•</span></div>
            <div id="pagination" class="pagination"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="customerModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="customerModalTitle">æ–°å¢å®¢æˆ·</h3>
          <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="customerForm">
            <input type="hidden" id="customerId" />
            <div class="form-row">
              <div class="form-group">
                <label for="customerName">åç§° *</label>
                <input
                  id="customerName"
                  required
                  placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°"
                />
              </div>
              <div class="form-group">
                <label for="customerPhone">ç”µè¯</label>
                <input id="customerPhone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="customerAddress">åœ°å€</label>
                <input id="customerAddress" placeholder="è¯·è¾“å…¥åœ°å€" />
              </div>
            </div>
            <div class="form-row" id="statusRow" style="display: none">
              <div class="form-group">
                <label for="customerStatus">çŠ¶æ€</label>
                <select id="customerStatus">
                  <option value="active">æœ‰æ•ˆ</option>
                  <option value="inactive">æ— æ•ˆ</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="customerRemark">å¤‡æ³¨</label>
                <textarea
                  id="customerRemark"
                  placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                ></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeCustomerModal()">
            å–æ¶ˆ
          </button>
          <button class="btn btn-primary" onclick="saveCustomer()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // åˆ—è¡¨çŠ¶æ€
      let currentPage = 1;
      let pageSize = 10;
      let searchQuery = "";
      let statusFilter = "";
      let editingId = null;

      document.addEventListener("DOMContentLoaded", () => {
        initCommonPage("customers");
        loadCustomers();
      });

      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }
      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }
      function showError(msg) {
        alert(msg);
      }
      function showSuccess(msg) {
        alert(msg);
      }

      async function loadCustomers() {
        showLoading();
        try {
          const params = new URLSearchParams({
            page: currentPage,
            size: pageSize,
          });
          if (searchQuery) params.append("search", searchQuery);
          if (statusFilter) params.append("status", statusFilter);
          // é»˜è®¤ä¸éšè—æ•£æˆ·ï¼ˆinclude_default=trueï¼‰
          const res = await fetch(`/api/customers?${params.toString()}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (!data.success) return showError(data.message || "åŠ è½½å®¢æˆ·å¤±è´¥");
          renderTable(data.data);
          renderPagination(data.pagination);
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        } finally {
          hideLoading();
        }
      }

      function renderTable(list) {
        const tbody = document.getElementById("customersTableBody");
        if (!list || list.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">æš‚æ— æ•°æ®</td></tr>';
          return;
        }
        tbody.innerHTML = list
          .map(
            (c) => `
          <tr>
            <td>${c.name}${
              c.is_default
                ? ' <span class="status-badge status-approved">é»˜è®¤</span>'
                : ""
            }</td>
            <td>${c.phone || ""}</td>
            <td>${c.address || ""}</td>
            <td><span class="status-badge ${
              c.status === "active" ? "status-active" : "status-inactive"
            }">${c.status === "active" ? "æœ‰æ•ˆ" : "æ— æ•ˆ"}</span></td>
            <td>${c.created_at || ""}</td>
            <td>${c.remark || ""}</td>
            <td>
              <div class="action-buttons">
                ${
                  !c.is_default
                    ? `
                  <button class="btn-link" title="ç¼–è¾‘" onclick="openCustomerModal(${c.id})">âœï¸</button>
                  <button class="btn-link" title="åˆ é™¤" onclick="deleteCustomer(${c.id})">ğŸ—‘ï¸</button>
                `
                    : `<span style='color:#999'>ä¸å¯ç¼–è¾‘</span>`
                }
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      function renderPagination(p) {
        document.getElementById(
          "pageInfo"
        ).textContent = `å…± ${p.total} æ¡è®°å½•ï¼Œç¬¬ ${p.page} / ${p.total_pages} é¡µ`;
        const el = document.getElementById("pagination");
        let html = "";
        if (p.has_prev)
          html += `<button class="page-btn" onclick="gotoPage(${
            p.page - 1
          })">ä¸Šä¸€é¡µ</button>`;
        const start = Math.max(1, p.page - 2),
          end = Math.min(p.total_pages, p.page + 2);
        for (let i = start; i <= end; i++)
          html += `<button class="page-btn ${
            i === p.page ? "active" : ""
          }" onclick="gotoPage(${i})">${i}</button>`;
        if (p.has_next)
          html += `<button class="page-btn" onclick="gotoPage(${
            p.page + 1
          })">ä¸‹ä¸€é¡µ</button>`;
        el.innerHTML = html;
      }

      function gotoPage(page) {
        currentPage = page;
        loadCustomers();
      }
      function handleSearch() {
        searchQuery = document.getElementById("searchInput").value.trim();
        currentPage = 1;
        loadCustomers();
      }
      function handleFilter() {
        statusFilter = document.getElementById("statusFilter").value;
        currentPage = 1;
        loadCustomers();
      }

      function openCustomerModal(id) {
        const title = document.getElementById("customerModalTitle");
        const statusRow = document.getElementById("statusRow");
        const form = document.getElementById("customerForm");
        form.reset();
        document.getElementById("customerId").value = "";
        editingId = null;
        statusRow.style.display = "none";
        title.textContent = "æ–°å¢å®¢æˆ·";
        if (id) {
          // è¿›å…¥ç¼–è¾‘
          loadCustomerDetail(id);
        }
        document.getElementById("customerModal").style.display = "flex";
      }

      function closeCustomerModal() {
        document.getElementById("customerModal").style.display = "none";
      }

      async function loadCustomerDetail(id) {
        try {
          const res = await fetch(`/api/customers/${id}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (!data.success)
            return showError(data.message || "è·å–å®¢æˆ·è¯¦æƒ…å¤±è´¥");
          const c = data.data;
          editingId = c.id;
          document.getElementById("customerModalTitle").textContent =
            "ç¼–è¾‘å®¢æˆ·";
          document.getElementById("customerId").value = c.id;
          document.getElementById("customerName").value = c.name || "";
          document.getElementById("customerPhone").value = c.phone || "";
          document.getElementById("customerAddress").value = c.address || "";
          document.getElementById("customerRemark").value = c.remark || "";
          // ç¼–è¾‘æ—¶å¯æ”¹çŠ¶æ€
          const statusRow = document.getElementById("statusRow");
          statusRow.style.display = "block";
          document.getElementById("customerStatus").value =
            c.status || "active";
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        }
      }

      async function saveCustomer() {
        const name = document.getElementById("customerName").value.trim();
        const phone = document.getElementById("customerPhone").value.trim();
        const address = document.getElementById("customerAddress").value.trim();
        const remark = document.getElementById("customerRemark").value.trim();
        if (!name) return showError("è¯·å¡«å†™å®¢æˆ·åç§°");
        const payload = { name, phone, address, remark };
        let url = "/api/customers";
        let method = "POST";
        if (editingId) {
          url = `/api/customers/${editingId}`;
          method = "PUT";
          const status = document.getElementById("customerStatus").value;
          payload.status = status;
        }
        try {
          showLoading();
          const res = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) return showError(data.message || "ä¿å­˜å¤±è´¥");
          showSuccess("ä¿å­˜æˆåŠŸ");
          closeCustomerModal();
          loadCustomers();
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        } finally {
          hideLoading();
        }
      }

      async function deleteCustomer(id) {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥å®¢æˆ·å—ï¼Ÿ")) return;
        try {
          showLoading();
          const res = await fetch(`/api/customers/${id}`, {
            method: "DELETE",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (!data.success) return showError(data.message || "åˆ é™¤å¤±è´¥");
          showSuccess("åˆ é™¤æˆåŠŸ");
          loadCustomers();
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        } finally {
          hideLoading();
        }
      }
    </script>
  </body>
</html>
