<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿›è´§ç®¡ç† - ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >è¿”å›é¦–é¡µ</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <main class="content">
        <div class="content-header">
          <h2>è¿›è´§ç®¡ç†</h2>
          <div class="breadcrumb">
            <span>é¦–é¡µ > è¿›è´§ç®¡ç†</span>
          </div>
        </div>

        <div class="content-body">
          <!-- æ“ä½œæ  -->
          <div class="action-bar">
            <button class="btn btn-primary" onclick="openImportModal()">
              å¯¼å…¥é‡‡è´­è®¢å•
            </button>
            <div class="search-container">
              <input
                id="searchPoInput"
                class="search-input"
                placeholder="æœç´¢é‡‡è´­å•å·/ä¾›åº”å•†"
                onkeyup="handlePoSearch()"
              />
            </div>
          </div>

          <!-- è¿›è´§å•åŸºæœ¬ä¿¡æ¯ -->
          <form id="incomingForm">
            <div class="form-row">
              <div class="form-group">
                <label>å…³è”é‡‡è´­å•å·</label>
                <input
                  id="purchaseOrderNo"
                  placeholder="é€šè¿‡å¯¼å…¥é€‰æ‹©"
                  readonly
                />
                <input type="hidden" id="purchaseId" />
              </div>
              <div class="form-group">
                <label>ä¾›åº”å•† *</label>
                <select id="supplierSelect" required>
                  <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
                </select>
              </div>
              <div class="form-group">
                <label>å…¥åº“æ—¥æœŸ *</label>
                <input id="incomingDate" type="date" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea
                  id="incomingRemark"
                  placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                ></textarea>
              </div>
            </div>
          </form>

          <!-- æ˜ç»†è¡¨ -->
          <div class="products-section">
            <div style="margin-bottom: 10px; display: flex; gap: 10px">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="openAddProductSelector()"
              >
                æ·»åŠ å•†å“
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="clearDetails()"
              >
                æ¸…ç©ºæ˜ç»†
              </button>
            </div>
            <div class="products-table-container">
              <table class="products-table" id="detailsTable">
                <thead>
                  <tr>
                    <th>å•†å“ç¼–ç </th>
                    <th>å•†å“åç§°</th>
                    <th>å•ä½</th>
                    <th>æ•°é‡</th>
                    <th>æˆæœ¬å•ä»·</th>
                    <th>å°è®¡</th>
                    <th>ç”Ÿäº§æ—¥æœŸ</th>
                    <th>åˆ°æœŸæ—¥æœŸ</th>
                    <th>æ‰¹å·</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="detailsTableBody"></tbody>
              </table>
            </div>
            <div class="total-section">
              <span class="total-label">è¿›è´§æ€»é‡‘é¢ï¼š</span>
              <span class="total-amount" id="totalAmount">ï¿¥0.00</span>
              <div style="flex: 1"></div>
              <button class="btn btn-primary" onclick="saveIncoming()">
                ä¿å­˜è¿›è´§å•
              </button>
            </div>
          </div>

          <!-- å†å²å…¥åº“è®°å½• -->
          <div class="section" style="margin-top: 20px">
            <div
              class="section-header"
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <h3>å†å²å…¥åº“è®°å½•</h3>
              <div class="search-container">
                <input
                  id="historySearchInput"
                  class="search-input"
                  placeholder="æœç´¢å…¥åº“å•å·/ä¾›åº”å•†/ç»æ‰‹äºº"
                  onkeyup="reloadIncomingHistory(true)"
                />
              </div>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>å…¥åº“å•å·</th>
                    <th>é‡‡è´­å•å·</th>
                    <th>ä¾›åº”å•†</th>
                    <th>å…¥åº“æ—¥æœŸ</th>
                    <th>é‡‘é¢</th>
                    <th>ç»æ‰‹äºº</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                  </tr>
                </thead>
                <tbody id="incomingHistoryBody"></tbody>
              </table>
            </div>
            <div class="pagination-container">
              <div class="page-info">
                <span id="incomingHistoryInfo">å…± 0 æ¡è®°å½•</span>
              </div>
              <div id="incomingHistoryPagination" class="pagination"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- å¯¼å…¥é‡‡è´­å•å¼¹çª— -->
    <div id="importModal" class="modal" style="display: none">
      <div class="modal-content" style="max-width: 900px">
        <div class="modal-header">
          <h3>å¯¼å…¥é‡‡è´­è®¢å•ï¼ˆä»…æ˜¾ç¤ºå·²äº¤ä»˜ï¼‰</h3>
          <span class="close" onclick="closeImportModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="action-bar" style="margin: 0 0 10px 0">
            <div class="search-container">
              <input
                id="poSearchInput"
                class="search-input"
                placeholder="æœç´¢è®¢å•å·/ä¾›åº”å•†/ç”³è¯·äºº"
                onkeyup="reloadPoList()"
              />
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>è®¢å•å·</th>
                  <th>ä¾›åº”å•†</th>
                  <th>çŠ¶æ€</th>
                  <th>æ€»é‡‘é¢</th>
                  <th>ç”³è¯·äºº</th>
                  <th>ç”³è¯·æ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="poTableBody"></tbody>
            </table>
          </div>
          <div class="pagination-container">
            <div class="page-info">
              <span id="poPageInfo">å…± 0 æ¡è®°å½•</span>
            </div>
            <div id="poPagination" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å•†å“é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼Œç”¨äºè¡¥å……æˆ–ä¿®æ”¹æ˜ç»†ï¼‰ -->
    <div id="productSelectorModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>é€‰æ‹©å•†å“</h3>
          <span class="close" onclick="closeProductSelector()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="search-container">
            <input
              id="productSearchInput"
              class="search-input"
              placeholder="æœç´¢å•†å“åç§°/ç¼–ç "
              onkeyup="renderProductsList()"
            />
          </div>
          <div id="productsList" class="products-list"></div>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      let suppliers = [];
      let products = [];
      let details = [];
      let currentPoPage = 1,
        poPageSize = 10,
        poSearch = "";

      document.addEventListener("DOMContentLoaded", async () => {
        initCommonPage("incoming");
        document.getElementById("incomingDate").valueAsDate = new Date();
        await Promise.all([loadSuppliers(), loadProducts()]);
        reloadIncomingHistory();
      });

      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }
      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }
      function showError(msg) {
        alert(msg);
      }
      function showSuccess(msg) {
        alert(msg);
      }

      async function loadSuppliers() {
        try {
          const res = await fetch("/api/suppliers?size=1000&status=active", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (data.success) {
            suppliers = data.data;
            fillSupplierSelect();
          }
        } catch (e) {
          console.error(e);
        }
      }
      function fillSupplierSelect() {
        const sel = document.getElementById("supplierSelect");
        sel.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>';
        suppliers.forEach((s) => sel.appendChild(new Option(s.name, s.id)));
      }

      async function loadProducts() {
        try {
          const res = await fetch("/api/products?size=1000&status=active", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (data.success) {
            products = data.data;
          }
        } catch (e) {
          console.error(e);
        }
      }

      function openImportModal() {
        currentPoPage = 1;
        poSearch = "";
        reloadPoList();
        document.getElementById("importModal").style.display = "flex";
      }
      function closeImportModal() {
        document.getElementById("importModal").style.display = "none";
      }
      function handlePoSearch() {
        poSearch = document.getElementById("searchPoInput").value.trim();
        currentPoPage = 1;
        reloadPoList();
      }

      async function reloadPoList() {
        // åªæ˜¾ç¤ºå·²äº¤ä»˜çš„é‡‡è´­è®¢å•ï¼Œæ–¹ä¾¿å¯¼å…¥
        const modalInput = document.getElementById("poSearchInput");
        if (modalInput) {
          poSearch = modalInput.value.trim();
        }
        const params = new URLSearchParams({
          page: currentPoPage,
          size: poPageSize,
        });
        if (poSearch) params.append("search", poSearch);
        const res = await fetch("/api/purchase-orders?" + params.toString(), {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") },
        });
        const data = await res.json();
        if (!data.success) {
          showError(data.message || "åŠ è½½é‡‡è´­è®¢å•å¤±è´¥");
          return;
        }
        const list = (data.data || []).filter((o) => o.status === "delivered");
        renderPoTable(list);
        renderPoPagination(data.pagination);
      }
      function renderPoTable(list) {
        const tbody = document.getElementById("poTableBody");
        if (!list.length) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">æš‚æ— å¯å¯¼å…¥çš„é‡‡è´­è®¢å•</td></tr>';
          return;
        }
        tbody.innerHTML = list
          .map(
            (o) => `
          <tr>
            <td>${o.order_no}</td>
            <td>${o.supplier_name || ""}</td>
            <td><span class="status-badge status-delivered">å·²äº¤ä»˜</span></td>
            <td>ï¿¥${(o.total_amount || 0).toFixed(2)}</td>
            <td>${o.apply_user_name || ""}</td>
            <td>${o.apply_time || ""}</td>
            <td>
              <button class='btn btn-primary btn-small' onclick='importPurchase(${
                o.id
              })'>å¯¼å…¥</button>
            </td>
          </tr>
        `
          )
          .join("");
      }
      function renderPoPagination(p) {
        const infoEl = document.getElementById("poPageInfo");
        const el = document.getElementById("poPagination");
        if (!p) {
          infoEl.textContent = "";
          el.innerHTML = "";
          return;
        }
        infoEl.textContent = `å…± ${p.total} æ¡è®°å½•ï¼Œç¬¬ ${p.page} / ${p.total_pages} é¡µ`;
        let html = "";
        if (p.has_prev)
          html += `<button class="page-btn" onclick="gotoPoPage(${
            p.page - 1
          })">ä¸Šä¸€é¡µ</button>`;
        const start = Math.max(1, p.page - 2),
          end = Math.min(p.total_pages, p.page + 2);
        for (let i = start; i <= end; i++)
          html += `<button class="page-btn ${
            i === p.page ? "active" : ""
          }" onclick="gotoPoPage(${i})">${i}</button>`;
        if (p.has_next)
          html += `<button class="page-btn" onclick="gotoPoPage(${
            p.page + 1
          })">ä¸‹ä¸€é¡µ</button>`;
        el.innerHTML = html;
      }
      function gotoPoPage(p) {
        currentPoPage = p;
        reloadPoList();
      }

      async function importPurchase(id) {
        // ä»é‡‡è´­è®¢å•æ‹‰å–è¯¦æƒ…ï¼Œå¡«å……åˆ°è¿›è´§å•æ˜ç»†
        try {
          const res = await fetch(`/api/purchase-orders/${id}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (!data.success)
            return showError(data.message || "è·å–é‡‡è´­è®¢å•è¯¦æƒ…å¤±è´¥");
          const order = data.data.order; // æ³¨æ„åç«¯ç»“æ„ {order, details}
          const dets = data.data.details;
          document.getElementById("purchaseOrderNo").value = order.order_no;
          document.getElementById("purchaseId").value = order.id;
          document.getElementById("supplierSelect").value = order.supplier_id;
          // å°†é‡‡è´­æ˜ç»†è½¬æˆè¿›è´§æ˜ç»†ç»“æ„
          details = dets.map((d) => ({
            product_id: d.product_id,
            code: d.code,
            name: d.product_name,
            unit: d.unit,
            quantity: d.quantity,
            cost_price: d.cost_price,
            amount: d.amount,
            production_date: "",
            expiry_date: "",
            batch_no: "",
            remark: d.remark || "",
          }));
          renderDetails();
          closeImportModal();
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        }
      }

      // æ¨¡æ¿å¯¼å…¥åŠŸèƒ½ç§»é™¤ï¼šä»…å…è®¸å¯¼å…¥å·²äº¤ä»˜è®¢å•å¹¶å…³è”é‡‡è´­å•å·

      function renderDetails() {
        const tbody = document.getElementById("detailsTableBody");
        if (!details.length) {
          tbody.innerHTML =
            '<tr><td colspan="10" class="text-center">æš‚æ— æ˜ç»†</td></tr>';
          updateTotal();
          return;
        }
        tbody.innerHTML = details
          .map(
            (it, idx) => `
          <tr>
            <td>${it.code || ""}</td>
            <td>${it.name || ""}</td>
            <td>${it.unit || ""}</td>
            <td><input class='form-input-small' type='number' min='1' step='1' value='${
              it.quantity || 1
            }' onchange='onQtyChange(${idx}, this.value)' /></td>
            <td><input class='form-input-small' type='number' min='0' step='0.01' value='${
              it.cost_price || 0
            }' onchange='onPriceChange(${idx}, this.value)' /></td>
            <td>ï¿¥${(it.amount || 0).toFixed(2)}</td>
            <td><input class='form-input-small' type='date' value='${
              it.production_date || ""
            }' onchange='onProdDate(${idx}, this.value)' /></td>
            <td><input class='form-input-small' type='date' value='${
              it.expiry_date || ""
            }' onchange='onExpDate(${idx}, this.value)' /></td>
            <td><input class='form-input-small' value='${
              it.batch_no || ""
            }' onchange='onBatch(${idx}, this.value)' /></td>
            <td><button class='btn-link' title='ç§»é™¤' onclick='removeDetail(${idx})'>ğŸ—‘ï¸</button></td>
          </tr>
        `
          )
          .join("");
        updateTotal();
      }
      function onQtyChange(i, v) {
        const q = parseFloat(v) || 0;
        details[i].quantity = q;
        details[i].amount = q * (parseFloat(details[i].cost_price) || 0);
        renderDetails();
      }
      function onPriceChange(i, v) {
        const p = parseFloat(v) || 0;
        details[i].cost_price = p;
        details[i].amount = (parseFloat(details[i].quantity) || 0) * p;
        renderDetails();
      }
      function onProdDate(i, v) {
        details[i].production_date = v;
      }
      function onExpDate(i, v) {
        details[i].expiry_date = v;
      }
      function onBatch(i, v) {
        details[i].batch_no = v;
      }
      function removeDetail(i) {
        details.splice(i, 1);
        renderDetails();
      }
      function clearDetails() {
        details = [];
        renderDetails();
      }
      function updateTotal() {
        const total = details.reduce(
          (s, it) => s + (parseFloat(it.amount) || 0),
          0
        );
        document.getElementById("totalAmount").textContent =
          "ï¿¥" + total.toFixed(2);
      }

      function openAddProductSelector() {
        renderProductsList();
        document.getElementById("productSelectorModal").style.display = "flex";
      }
      function closeProductSelector() {
        document.getElementById("productSelectorModal").style.display = "none";
      }
      function renderProductsList() {
        const keyword = (
          document.getElementById("productSearchInput").value || ""
        ).toLowerCase();
        const list = products.filter(
          (p) =>
            (p.name || "").toLowerCase().includes(keyword) ||
            (p.code || "").toLowerCase().includes(keyword)
        );
        const container = document.getElementById("productsList");
        if (!list.length) {
          container.innerHTML =
            '<div class="text-center p-10">æœªæ‰¾åˆ°å•†å“</div>';
          return;
        }
        container.innerHTML = list
          .map(
            (p) => `
          <div class='product-item'>
            <div class='product-info'>
              <div class='product-name'>${p.name}</div>
              <div class='product-code'>ç¼–ç : ${p.code}</div>
              <div class='product-price'>å»ºè®®æˆæœ¬: ï¿¥${(
                p.cost_price || 0
              ).toFixed(2)}</div>
            </div>
            <button class='btn btn-primary btn-small' onclick='addProduct(${
              p.id
            })'>é€‰æ‹©</button>
          </div>
        `
          )
          .join("");
      }
      function addProduct(pid) {
        const p = products.find((x) => x.id === pid);
        if (!p) return;
        details.push({
          product_id: p.id,
          code: p.code,
          name: p.name,
          unit: p.unit,
          quantity: 1,
          cost_price: parseFloat(p.cost_price || 0),
          amount: parseFloat(p.cost_price || 0),
          production_date: "",
          expiry_date: "",
          batch_no: "",
          remark: "",
        });
        renderDetails();
      }

      async function saveIncoming() {
        // æ ¡éªŒ
        const supplier_id = parseInt(
          document.getElementById("supplierSelect").value || ""
        );
        const incoming_date = document.getElementById("incomingDate").value;
        const remark = document.getElementById("incomingRemark").value.trim();
        const purchase_id =
          parseInt(document.getElementById("purchaseId").value || "") || null;
        if (!supplier_id) return showError("è¯·é€‰æ‹©ä¾›åº”å•†");
        if (!incoming_date) return showError("è¯·é€‰æ‹©å…¥åº“æ—¥æœŸ");
        if (!details.length) return showError("è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªå…¥åº“æ˜ç»†");
        for (const d of details) {
          if (
            !d.product_id ||
            !d.quantity ||
            d.quantity <= 0 ||
            !d.cost_price ||
            d.cost_price <= 0
          ) {
            return showError("æ˜ç»†å­˜åœ¨æ— æ•ˆçš„æ•°é‡æˆ–å•ä»·");
          }
        }

        try {
          showLoading();
          const payload = {
            supplier_id,
            incoming_date,
            remark,
            details: details.map((d) => ({
              product_id: d.product_id,
              quantity: d.quantity,
              cost_price: d.cost_price,
              production_date: d.production_date || null,
              expiry_date: d.expiry_date || null,
              batch_no: d.batch_no || null,
              remark: d.remark || "",
            })),
            purchase_id,
          };
          const res = await fetch("/api/incoming-orders", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) return showError(data.message || "ä¿å­˜å¤±è´¥");
          showSuccess("ä¿å­˜æˆåŠŸ");
          // æ¸…ç©ºè¡¨å•
          document.getElementById("incomingForm").reset();
          document.getElementById("purchaseOrderNo").value = "";
          document.getElementById("purchaseId").value = "";
          document.getElementById("incomingDate").valueAsDate = new Date();
          details = [];
          renderDetails();
          reloadIncomingHistory();
        } catch (e) {
          showError("ç½‘ç»œé”™è¯¯: " + e.message);
        } finally {
          hideLoading();
        }
      }

      // å†å²å…¥åº“è®°å½•é€»è¾‘
      let incomingHistoryPage = 1,
        incomingHistorySize = 10,
        incomingHistorySearch = "";
      function gotoIncomingHistoryPage(p) {
        incomingHistoryPage = p;
        reloadIncomingHistory();
      }
      async function reloadIncomingHistory(reset) {
        if (reset) {
          incomingHistoryPage = 1;
        }
        const kwEl = document.getElementById("historySearchInput");
        incomingHistorySearch = kwEl ? kwEl.value.trim() : "";
        const params = new URLSearchParams({
          page: incomingHistoryPage,
          size: incomingHistorySize,
        });
        if (incomingHistorySearch)
          params.append("search", incomingHistorySearch);
        const res = await fetch("/api/incoming-orders?" + params.toString(), {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") },
        });
        const data = await res.json();
        if (!data.success) {
          return;
        }
        renderIncomingHistoryTable(data.data || []);
        renderIncomingHistoryPagination(data.pagination);
      }
      function renderIncomingHistoryTable(rows) {
        const tbody = document.getElementById("incomingHistoryBody");
        if (!rows.length) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">æš‚æ— å…¥åº“è®°å½•</td></tr>';
          return;
        }
        tbody.innerHTML = rows
          .map(
            (r) => `
          <tr>
            <td>${r.order_no}</td>
            <td>${r.purchase_order_no || ""}</td>
            <td>${r.supplier_name || ""}</td>
            <td>${r.incoming_date || ""}</td>
            <td>ï¿¥${(r.total_amount || 0).toFixed(2)}</td>
            <td>${r.user_name || ""}</td>
            <td>${r.created_at || ""}</td>
          </tr>
        `
          )
          .join("");
      }
      function renderIncomingHistoryPagination(p) {
        const infoEl = document.getElementById("incomingHistoryInfo");
        const el = document.getElementById("incomingHistoryPagination");
        if (!p) {
          infoEl.textContent = "";
          el.innerHTML = "";
          return;
        }
        infoEl.textContent = `å…± ${p.total} æ¡è®°å½•ï¼Œç¬¬ ${p.page} / ${p.total_pages} é¡µ`;
        let html = "";
        if (p.has_prev)
          html += `<button class="page-btn" onclick="gotoIncomingHistoryPage(${
            p.page - 1
          })">ä¸Šä¸€é¡µ</button>`;
        const start = Math.max(1, p.page - 2),
          end = Math.min(p.total_pages, p.page + 2);
        for (let i = start; i <= end; i++)
          html += `<button class="page-btn ${
            i === p.page ? "active" : ""
          }" onclick="gotoIncomingHistoryPage(${i})">${i}</button>`;
        if (p.has_next)
          html += `<button class="page-btn" onclick="gotoIncomingHistoryPage(${
            p.page + 1
          })">ä¸‹ä¸€é¡µ</button>`;
        el.innerHTML = html;
      }
    </script>
  </body>
</html>
