<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å•†å“ç®¡ç† - ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >è¿”å›é¦–é¡µ</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <main class="content">
        <div class="content-header">
          <h2>å•†å“ç®¡ç†</h2>
          <div class="breadcrumb">
            <span>é¦–é¡µ > å•†å“ç®¡ç†</span>
          </div>
        </div>

        <div class="content-body">
          <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
          <div class="action-bar">
            <button id="addProductBtn" class="btn btn-primary">
              <span>â• æ·»åŠ å•†å“</span>
            </button>
            <div class="search-container">
              <input
                type="text"
                id="searchInput"
                placeholder="æœç´¢å•†å“ç¼–ç ã€åç§°æˆ–å“ç‰Œ..."
                class="search-input"
              />
              <select id="categoryFilter" class="filter-select">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
              </select>
              <select id="statusFilter" class="filter-select">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">å¯ç”¨</option>
                <option value="inactive">ç¦ç”¨</option>
              </select>
              <button id="searchBtn" class="btn btn-secondary">æœç´¢</button>
              <button id="resetBtn" class="btn btn-secondary">é‡ç½®</button>
            </div>
          </div>

          <!-- å•†å“åˆ—è¡¨è¡¨æ ¼ -->
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>å•†å“ç¼–ç </th>
                  <th>å•†å“åç§°</th>
                  <th>åˆ†ç±»</th>
                  <th>å“ç‰Œ</th>
                  <th>å•ä½</th>
                  <th>é”€å”®ä»·æ ¼</th>
                  <th>åº“å­˜æ•°é‡</th>
                  <th>çŠ¶æ€</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
              </tbody>
            </table>
          </div>

          <!-- åˆ†é¡µç»„ä»¶ -->
          <div class="pagination-container">
            <div class="pagination-info">
              <span id="paginationInfo">æ˜¾ç¤ºç¬¬ 0 åˆ° 0 é¡¹ï¼Œå…± 0 é¡¹</span>
            </div>
            <div class="pagination">
              <button id="prevPageBtn" class="btn btn-secondary" disabled>
                ä¸Šä¸€é¡µ
              </button>
              <span id="pageNumbers"></span>
              <button id="nextPageBtn" class="btn btn-secondary" disabled>
                ä¸‹ä¸€é¡µ
              </button>
            </div>
          </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘å•†å“æ¨¡æ€æ¡† -->
        <div id="productModal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="modalTitle">æ·»åŠ å•†å“</h3>
              <span class="close">&times;</span>
            </div>
            <div class="modal-body">
              <form id="productForm">
                <div class="form-row">
                  <div class="form-group">
                    <label for="productCode">å•†å“ç¼–ç </label>
                    <input
                      type="text"
                      id="productCode"
                      name="code"
                      placeholder="å¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ"
                    />
                  </div>
                  <div class="form-group">
                    <label for="productName">å•†å“åç§° *</label>
                    <input
                      type="text"
                      id="productName"
                      name="name"
                      required
                      placeholder="è¯·è¾“å…¥å•†å“åç§°"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="productCategory">åˆ†ç±»</label>
                    <input
                      type="text"
                      id="productCategory"
                      name="category"
                      placeholder="è¯·è¾“å…¥å•†å“åˆ†ç±»"
                      list="categoryList"
                    />
                    <datalist id="categoryList"></datalist>
                  </div>
                  <div class="form-group">
                    <label for="productBrand">å“ç‰Œ</label>
                    <input
                      type="text"
                      id="productBrand"
                      name="brand"
                      placeholder="è¯·è¾“å…¥å“ç‰Œ"
                      list="brandList"
                    />
                    <datalist id="brandList"></datalist>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="productUnit">å•ä½</label>
                    <input
                      type="text"
                      id="productUnit"
                      name="unit"
                      value="ä»¶"
                      placeholder="ä»¶/ä¸ª/ç›’/ç“¶ç­‰"
                    />
                  </div>
                  <div class="form-group">
                    <label for="productPrice">é”€å”®ä»·æ ¼ *</label>
                    <input
                      type="number"
                      id="productPrice"
                      name="selling_price"
                      step="0.01"
                      min="0.01"
                      required
                      placeholder="0.00"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label for="productRemark">å¤‡æ³¨</label>
                  <textarea
                    id="productRemark"
                    name="remark"
                    rows="3"
                    placeholder="å•†å“å¤‡æ³¨ä¿¡æ¯"
                  ></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" id="cancelBtn">
                å–æ¶ˆ
              </button>
              <button type="button" class="btn btn-primary" id="saveBtn">
                ä¿å­˜
              </button>
            </div>
          </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div
          id="loadingIndicator"
          class="loading-overlay"
          style="display: none"
        >
          <div class="loading-spinner"></div>
          <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
        </div>
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // å…¨å±€å˜é‡
      let currentPage = 1;
      let pageSize = 10;
      let currentEditId = null;

      // é¡µé¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initCommonPage("products");
        initProductPage();
      });

      // åˆå§‹åŒ–å•†å“é¡µé¢
      function initProductPage() {
        loadProducts();
        loadCategories();
        loadBrands();
        bindEvents();
      }

      // ç»‘å®šäº‹ä»¶
      function bindEvents() {
        // æ·»åŠ å•†å“æŒ‰é’®
        document
          .getElementById("addProductBtn")
          .addEventListener("click", () => {
            openProductModal();
          });

        // æœç´¢æŒ‰é’®
        document.getElementById("searchBtn").addEventListener("click", () => {
          currentPage = 1;
          loadProducts();
        });

        // é‡ç½®æŒ‰é’®
        document.getElementById("resetBtn").addEventListener("click", () => {
          document.getElementById("searchInput").value = "";
          document.getElementById("categoryFilter").value = "";
          document.getElementById("statusFilter").value = "";
          currentPage = 1;
          loadProducts();
        });

        // æœç´¢æ¡†å›è½¦
        document
          .getElementById("searchInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              currentPage = 1;
              loadProducts();
            }
          });

        // æ¨¡æ€æ¡†äº‹ä»¶
        document
          .querySelector(".close")
          .addEventListener("click", closeProductModal);
        document
          .getElementById("cancelBtn")
          .addEventListener("click", closeProductModal);
        document
          .getElementById("saveBtn")
          .addEventListener("click", saveProduct);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener("click", (e) => {
          const modal = document.getElementById("productModal");
          if (e.target === modal) {
            closeProductModal();
          }
        });

        // åˆ†é¡µæŒ‰é’®
        document.getElementById("prevPageBtn").addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            loadProducts();
          }
        });

        document.getElementById("nextPageBtn").addEventListener("click", () => {
          currentPage++;
          loadProducts();
        });
      }

      // åŠ è½½å•†å“åˆ—è¡¨
      async function loadProducts() {
        try {
          showLoading(true);

          const params = new URLSearchParams({
            page: currentPage,
            size: pageSize,
            search: document.getElementById("searchInput").value,
            category: document.getElementById("categoryFilter").value,
            status: document.getElementById("statusFilter").value,
          });

          const response = await fetch(`/api/products?${params}`);
          const data = await response.json();

          if (data.success) {
            renderProductTable(data.data);
            renderPagination(data.pagination);
          } else {
            showError("åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥: " + data.message);
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        } finally {
          showLoading(false);
        }
      }

      // æ¸²æŸ“å•†å“è¡¨æ ¼
      function renderProductTable(products) {
        const tbody = document.getElementById("productTableBody");

        if (products.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="10" class="text-center">æš‚æ— æ•°æ®</td></tr>';
          return;
        }

        tbody.innerHTML = products
          .map(
            (product) => `
          <tr>
            <td>${product.code || "-"}</td>
            <td>${product.name}</td>
            <td>${product.category || "-"}</td>
            <td>${product.brand || "-"}</td>
            <td>${product.unit}</td>
            <td>Â¥${product.selling_price.toFixed(2)}</td>
            <td>${product.stock_quantity}</td>
            <td>
              <span class="status-badge ${
                product.status === "active"
                  ? "status-active"
                  : "status-inactive"
              }">
                ${product.status === "active" ? "å¯ç”¨" : "ç¦ç”¨"}
              </span>
            </td>
            <td>${product.created_at}</td>
            <td class="action-buttons">
              <button class="btn-link" onclick="editProduct(${
                product.id
              })" title="ç¼–è¾‘">
                âœï¸
              </button>
              <button class="btn-link" onclick="toggleProductStatus(${
                product.id
              }, '${product.status}')" title="${
              product.status === "active" ? "ç¦ç”¨" : "å¯ç”¨"
            }">
                ${product.status === "active" ? "ğŸš«" : "âœ…"}
              </button>
              <button class="btn-link" onclick="deleteProduct(${
                product.id
              })" title="åˆ é™¤">
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // æ¸²æŸ“åˆ†é¡µ
      function renderPagination(pagination) {
        const info = document.getElementById("paginationInfo");
        const start = (pagination.page - 1) * pagination.size + 1;
        const end = Math.min(
          pagination.page * pagination.size,
          pagination.total
        );
        info.textContent = `æ˜¾ç¤ºç¬¬ ${start} åˆ° ${end} é¡¹ï¼Œå…± ${pagination.total} é¡¹`;

        document.getElementById("prevPageBtn").disabled = !pagination.has_prev;
        document.getElementById("nextPageBtn").disabled = !pagination.has_next;

        // ç”Ÿæˆé¡µç 
        const pageNumbers = document.getElementById("pageNumbers");
        const pages = [];
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.page + 2);

        for (let i = startPage; i <= endPage; i++) {
          pages.push(`
            <button class="page-btn ${i === pagination.page ? "active" : ""}" 
                    onclick="goToPage(${i})">${i}</button>
          `);
        }

        pageNumbers.innerHTML = pages.join("");
      }

      // è·³è½¬åˆ°æŒ‡å®šé¡µ
      function goToPage(page) {
        currentPage = page;
        loadProducts();
      }

      // åŠ è½½åˆ†ç±»åˆ—è¡¨
      async function loadCategories() {
        try {
          const response = await fetch("/api/products/categories");
          const data = await response.json();

          if (data.success) {
            const select = document.getElementById("categoryFilter");
            const datalist = document.getElementById("categoryList");

            // å¡«å……ç­›é€‰ä¸‹æ‹‰æ¡†
            data.data.forEach((category) => {
              const option = document.createElement("option");
              option.value = category;
              option.textContent = category;
              select.appendChild(option);
            });

            // å¡«å……è¾“å…¥æç¤º
            datalist.innerHTML = data.data
              .map((category) => `<option value="${category}"></option>`)
              .join("");
          }
        } catch (error) {
          console.error("åŠ è½½åˆ†ç±»å¤±è´¥:", error);
        }
      }

      // åŠ è½½å“ç‰Œåˆ—è¡¨
      async function loadBrands() {
        try {
          const response = await fetch("/api/products/brands");
          const data = await response.json();

          if (data.success) {
            const datalist = document.getElementById("brandList");
            datalist.innerHTML = data.data
              .map((brand) => `<option value="${brand}"></option>`)
              .join("");
          }
        } catch (error) {
          console.error("åŠ è½½å“ç‰Œå¤±è´¥:", error);
        }
      }

      // æ‰“å¼€å•†å“æ¨¡æ€æ¡†
      function openProductModal(productId = null) {
        currentEditId = productId;
        const modal = document.getElementById("productModal");
        const title = document.getElementById("modalTitle");
        const form = document.getElementById("productForm");

        title.textContent = productId ? "ç¼–è¾‘å•†å“" : "æ·»åŠ å•†å“";
        form.reset();

        if (productId) {
          loadProductForEdit(productId);
        }

        modal.style.display = "block";
      }

      // åŠ è½½å•†å“æ•°æ®ç”¨äºç¼–è¾‘
      async function loadProductForEdit(productId) {
        try {
          const response = await fetch(`/api/products/${productId}`);
          const data = await response.json();

          if (data.success) {
            const product = data.data;
            document.getElementById("productCode").value = product.code || "";
            document.getElementById("productName").value = product.name;
            document.getElementById("productCategory").value =
              product.category || "";
            document.getElementById("productBrand").value = product.brand || "";
            document.getElementById("productUnit").value = product.unit;
            document.getElementById("productPrice").value =
              product.selling_price;
            document.getElementById("productRemark").value =
              product.remark || "";
          } else {
            showError("åŠ è½½å•†å“æ•°æ®å¤±è´¥: " + data.message);
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // å…³é—­å•†å“æ¨¡æ€æ¡†
      function closeProductModal() {
        document.getElementById("productModal").style.display = "none";
        currentEditId = null;
      }

      // ä¿å­˜å•†å“
      async function saveProduct() {
        try {
          const form = document.getElementById("productForm");
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          // éªŒè¯å¿…å¡«å­—æ®µ
          if (!data.name || !data.selling_price) {
            showError("è¯·å¡«å†™å•†å“åç§°å’Œé”€å”®ä»·æ ¼");
            return;
          }

          const url = currentEditId
            ? `/api/products/${currentEditId}`
            : "/api/products";
          const method = currentEditId ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            showSuccess(result.message);
            closeProductModal();
            loadProducts();
          } else {
            showError(result.message);
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // ç¼–è¾‘å•†å“
      function editProduct(productId) {
        openProductModal(productId);
      }

      // åˆ‡æ¢å•†å“çŠ¶æ€
      async function toggleProductStatus(productId, currentStatus) {
        const newStatus = currentStatus === "active" ? "inactive" : "active";
        const action = newStatus === "active" ? "å¯ç”¨" : "ç¦ç”¨";

        if (!confirm(`ç¡®å®šè¦${action}è¯¥å•†å“å—ï¼Ÿ`)) return;

        try {
          const response = await fetch(`/api/products/${productId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status: newStatus }),
          });

          const data = await response.json();

          if (data.success) {
            showSuccess(`å•†å“${action}æˆåŠŸ`);
            loadProducts();
          } else {
            showError(data.message);
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // åˆ é™¤å•†å“
      async function deleteProduct(productId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥å•†å“å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼")) return;

        try {
          const response = await fetch(`/api/products/${productId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (data.success) {
            showSuccess("å•†å“åˆ é™¤æˆåŠŸ");
            loadProducts();
          } else {
            showError(data.message);
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading(show) {
        const indicator = document.getElementById("loadingIndicator");
        indicator.style.display = show ? "flex" : "none";
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        alert("é”™è¯¯: " + message);
      }

      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      function showSuccess(message) {
        alert("æˆåŠŸ: " + message);
      }
    </script>
  </body>
</html>
