<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>供应商管理 - 便利店进销存系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- 顶部导航栏 -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>便利店进销存系统</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >返回首页</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">退出登录</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- 侧边栏 -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- 菜单项将通过JavaScript动态生成 -->
          </ul>
        </nav>
      </aside>

      <!-- 主内容区域 -->
      <main class="content">
        <div class="content-header">
          <h2>供应商管理</h2>
          <div class="breadcrumb">
            <span>首页 > 供应商管理</span>
          </div>
        </div>

        <div class="content-body">
          <div id="msgArea"></div>

          <div class="action-bar">
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <button class="btn btn-primary" id="tabManageBtn" disabled>
                供应商管理
              </button>
            </div>
            <div class="search-container">
              <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="搜索供应商名称或联系人"
                onkeyup="handleSearch()"
              />
              <select
                class="filter-select"
                id="statusFilter"
                onchange="handleSearch()"
              >
                <option value="">全部状态</option>
                <option value="active">启用</option>
                <option value="inactive">禁用</option>
              </select>
              <button class="btn btn-primary" onclick="openSupplierModal()">
                新增供应商
              </button>
            </div>
          </div>

          <!-- 供应商管理列表 -->
          <div id="managePanel">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>名称</th>
                    <th>联系人</th>
                    <th>电话</th>
                    <th>地址</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="supplierTableBody"></tbody>
              </table>
            </div>
            <div class="pagination-container">
              <div class="page-info">
                <span id="pageInfo">共 0 条记录</span>
              </div>
              <div class="pagination" id="pagination"></div>
            </div>
          </div>

          <!-- 应付结算功能已迁移至独立页面 /payables -->
        </div>
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // 分页和筛选状态（仅供应商管理页）
      let page = 1;
      let size = 10;
      let searchQuery = "";
      let statusFilter = "";
      let currentSuppliers = [];

      document.addEventListener("DOMContentLoaded", function () {
        initCommonPage("suppliers");
        loadSuppliers();
      });

      function handleSearch() {
        searchQuery = document.getElementById("searchInput").value.trim();
        statusFilter = document.getElementById("statusFilter").value;
        page = 1;
        loadSuppliers();
      }

      // ========== 供应商管理 ==========
      async function loadSuppliers() {
        const tbody = document.getElementById("supplierTableBody");
        showLoading(tbody);
        try {
          const params = new URLSearchParams({
            page: String(page),
            size: String(size),
            search: searchQuery || "",
            status: statusFilter || "",
          });
          const res = await fetch(`/api/suppliers?${params.toString()}`);
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "加载失败");

          currentSuppliers = Array.isArray(data.data) ? data.data : [];
          renderSupplierTable(currentSuppliers);

          const p = data.pagination || {};
          const info = document.getElementById("pageInfo");
          if (info) {
            const total = p.total || 0;
            const cp = p.page || 1;
            const tp = p.total_pages || 1;
            info.textContent = `共 ${total} 条记录，第 ${cp}/${tp} 页`;
          }
          renderManagePagination(p);
        } catch (e) {
          showError(e.message, document.getElementById("msgArea"));
          const tbody = document.getElementById("supplierTableBody");
          if (tbody) tbody.innerHTML = "";
        }
      }

      function renderSupplierTable(rows) {
        const tbody = document.getElementById("supplierTableBody");
        if (!tbody) return;
        if (!rows || rows.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">暂无数据</td></tr>';
          return;
        }
        const html = rows
          .map((s) => {
            const statusText = s.status === "inactive" ? "禁用" : "启用";
            const toggleText = s.status === "inactive" ? "启用" : "禁用";
            return `
              <tr>
                <td>${s.name || "-"}</td>
                <td>${s.contact_person || "-"}</td>
                <td>${s.phone || "-"}</td>
                <td>${s.address || "-"}</td>
                <td>
                  <span class="status-badge ${
                    s.status === "inactive" ? "status-danger" : "status-ok"
                  }">${statusText}</span>
                </td>
                <td>${s.created_at || "-"}</td>
                <td>
                  <button class="btn btn-small" onclick="editSupplier(${
                    s.id
                  })">编辑</button>
                  <button class="btn btn-small" onclick="toggleSupplierStatus(${
                    s.id
                  })">${toggleText}</button>
                  <button class="btn btn-small btn-danger" onclick="deleteSupplier(${
                    s.id
                  })">删除</button>
                </td>
              </tr>
            `;
          })
          .join("");
        tbody.innerHTML = html;
      }

      function renderManagePagination(p) {
        const container = document.getElementById("pagination");
        if (!container) return;
        const cp = p?.page || 1;
        const totalPages = p?.total_pages || 1;
        const buttons = [];

        const addBtn = (label, target, disabled = false, active = false) => {
          buttons.push(
            `<button class="page-btn ${active ? "active" : ""}" ${
              disabled ? "disabled" : ""
            } onclick="gotoPageManage(${target})">${label}</button>`
          );
        };

        addBtn("上一页", Math.max(1, cp - 1), cp <= 1);
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || Math.abs(i - cp) <= 2) {
            addBtn(String(i), i, false, i === cp);
          } else if (i === cp - 3 || i === cp + 3) {
            buttons.push('<span style="padding:0 6px;">...</span>');
          }
        }
        addBtn("下一页", Math.min(totalPages, cp + 1), cp >= totalPages);
        container.innerHTML = buttons.join("");
      }

      function gotoPageManage(p) {
        page = p;
        loadSuppliers();
      }

      function editSupplier(id) {
        const row = currentSuppliers.find((s) => s.id === id);
        if (row) openSupplierModal(row);
      }

      async function toggleSupplierStatus(id) {
        const row = currentSuppliers.find((s) => s.id === id);
        if (!row) return;
        const newStatus = row.status === "inactive" ? "active" : "inactive";
        try {
          const res = await fetch(`/api/suppliers/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "操作失败");
          showSuccess("状态已更新", document.getElementById("msgArea"));
          loadSuppliers();
        } catch (e) {
          showError(e.message, document.getElementById("msgArea"));
        }
      }

      async function deleteSupplier(id) {
        if (!confirm("确认删除该供应商？该操作不可恢复。")) return;
        try {
          const res = await fetch(`/api/suppliers/${id}`, { method: "DELETE" });
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "删除失败");
          showSuccess("删除成功", document.getElementById("msgArea"));
          loadSuppliers();
        } catch (e) {
          showError(e.message, document.getElementById("msgArea"));
        }
      }

      // ========== 新增/编辑供应商 ==========
      function openSupplierModal(row) {
        const modal = document.getElementById("supplierModal");
        modal.style.display = "flex";
        document.getElementById("supplierId").value = row ? row.id : "";
        document.getElementById("supplierName").value = row?.name || "";
        document.getElementById("supplierContact").value =
          row?.contact_person || "";
        document.getElementById("supplierPhone").value = row?.phone || "";
        document.getElementById("supplierAddress").value = row?.address || "";
        document.getElementById("supplierRemark").value = row?.remark || "";
      }
      function closeSupplierModal() {
        document.getElementById("supplierModal").style.display = "none";
      }

      async function saveSupplier() {
        const id = document.getElementById("supplierId").value;
        const payload = {
          name: document.getElementById("supplierName").value.trim(),
          contact_person: document
            .getElementById("supplierContact")
            .value.trim(),
          phone: document.getElementById("supplierPhone").value.trim(),
          address: document.getElementById("supplierAddress").value.trim(),
          remark: document.getElementById("supplierRemark").value.trim(),
        };
        try {
          let res;
          if (id) {
            res = await fetch(`/api/suppliers/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
          } else {
            res = await fetch(`/api/suppliers`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "保存失败");
          showSuccess("保存成功", document.getElementById("msgArea"));
          closeSupplierModal();
          loadSuppliers();
        } catch (e) {
          showError(e.message, document.getElementById("msgArea"));
        }
      }
    </script>

    <!-- 供应商表单模态框 -->
    <div id="supplierModal" class="modal" style="display: none">
      <div class="modal-content" style="max-width: 720px">
        <div class="modal-header">
          <h3>供应商信息</h3>
          <span class="close" onclick="closeSupplierModal()">&times;</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="supplierId" />
          <div class="form-row">
            <div class="form-group">
              <label>名称 *</label>
              <input
                type="text"
                id="supplierName"
                required
                placeholder="供应商名称"
              />
            </div>
            <div class="form-group">
              <label>联系人</label>
              <input type="text" id="supplierContact" placeholder="联系人" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>电话</label>
              <input type="text" id="supplierPhone" placeholder="联系电话" />
            </div>
            <div class="form-group">
              <label>地址</label>
              <input type="text" id="supplierAddress" placeholder="地址" />
            </div>
          </div>
          <div class="form-group">
            <label>备注</label>
            <textarea id="supplierRemark" placeholder="备注"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSupplierModal()">
            取消
          </button>
          <button class="btn btn-primary" onclick="saveSupplier()">保存</button>
        </div>
      </div>
    </div>
  </body>
</html>
