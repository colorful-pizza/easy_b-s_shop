<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å•†å“é”€å”® - ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >è¿”å›é¦–é¡µ</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <main class="content">
        <div class="content-header">
          <h2>å•†å“é”€å”®</h2>
          <div class="breadcrumb">
            <span>é¦–é¡µ > å•†å“é”€å”®</span>
          </div>
        </div>

        <div class="content-body">
          <!-- æç¤ºåŒºåŸŸ -->
          <div id="msgArea"></div>

          <!-- æ“ä½œæ ï¼šæ‰«ç /è¾“å…¥æ¡ç åŠ å…¥è´­ç‰©è½¦ -->
          <div class="action-bar">
            <div
              class="search-container"
              style="flex-wrap: wrap; row-gap: 10px"
            >
              <input
                type="text"
                class="search-input"
                id="barcodeInput"
                placeholder="æ‰«ç /è¾“å…¥æ¡ç æˆ–åç§°åæŒ‰å›è½¦æ·»åŠ åˆ°è´­ç‰©è½¦"
                style="width: 420px; font-size: 16px"
              />
              <div id="suggestList" style="position: relative; width: 100%">
                <!-- ç®€æ˜“è”æƒ³ç»“æœï¼ˆå¯ç‚¹å‡»åŠ å…¥ï¼‰å°†æ’å…¥åˆ°æ­¤å¤„ -->
              </div>
            </div>
            <div>
              <select
                id="customerSelect"
                class="filter-select"
                title="é€‰æ‹©å®¢æˆ·"
              >
                <option value="">é€‰æ‹©å®¢æˆ·ï¼ˆé»˜è®¤æ•£æˆ·ï¼‰</option>
              </select>
              <input
                type="text"
                id="orderRemark"
                class="search-input"
                placeholder="è®¢å•å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                style="width: 220px"
              />
              <button class="btn btn-secondary" onclick="clearCart()">
                æ¸…ç©ºè´­ç‰©è½¦
              </button>
              <label
                style="margin-left: 10px; margin-right: 6px; user-select: none"
              >
                <input type="checkbox" id="printAfterCheckout" checked />
                ä¸‹å•åæ‰“å°å°ç¥¨
              </label>
              <button class="btn btn-primary" onclick="checkout()">
                ç»“ç®—ä¸‹å•
              </button>
            </div>
          </div>

          <!-- è´­ç‰©è½¦è¡¨æ ¼ -->
          <div class="table-container">
            <table class="data-table" id="cartTable">
              <thead>
                <tr>
                  <th style="width: 140px">å•†å“ç¼–ç </th>
                  <th>å•†å“åç§°</th>
                  <th style="width: 80px">å•ä½</th>
                  <th style="width: 100px">å•ä»·</th>
                  <th style="width: 100px">åº“å­˜</th>
                  <th style="width: 180px">æ•°é‡</th>
                  <th style="width: 120px">å°è®¡</th>
                  <th style="width: 80px">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="cartTableBody">
                <tr>
                  <td class="text-center" colspan="8">
                    è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·æ‰«ç æˆ–è¾“å…¥æ·»åŠ 
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- åˆè®¡åŒºåŸŸ -->
          <div class="pagination-container" style="justify-content: flex-end">
            <div
              class="page-info"
              style="display: flex; gap: 20px; align-items: center"
            >
              <span>å•†å“ç§ç±»ï¼š<b id="itemKinds">0</b></span>
              <span>æ€»æ•°é‡ï¼š<b id="totalQty">0</b></span>
              <span>åˆè®¡é‡‘é¢ï¼š<b id="totalAmount">Â¥0.00</b></span>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // è´­ç‰©è½¦æ•°æ®ç»“æ„ï¼š[{ product_id, code, name, unit, price, stock, quantity }]
      let cart = [];
      let customers = [];

      // é¡µé¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initCommonPage("sales");
        const input = document.getElementById("barcodeInput");
        input.addEventListener("keydown", onBarcodeEnter);
        input.focus();
        loadCustomers();
      });

      async function loadCustomers() {
        try {
          const res = await fetch(
            `/api/customers/search?limit=500&include_default=true`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "åŠ è½½å®¢æˆ·å¤±è´¥");
          customers = data.data || [];
          const sel = document.getElementById("customerSelect");
          // æ¸…ç©ºå¹¶é‡å»º
          sel.innerHTML =
            '<option value="">é€‰æ‹©å®¢æˆ·ï¼ˆé»˜è®¤æ•£æˆ·ï¼‰</option>' +
            customers
              .map(
                (c) =>
                  `<option value="${c.id}">${c.name}${
                    c.is_default ? "ï¼ˆæ•£æˆ·ï¼‰" : ""
                  }</option>`
              )
              .join("");
          // é»˜è®¤é€‰ä¸­æ•£æˆ·
          const def = customers.find((c) => c.is_default);
          if (def) sel.value = String(def.id);
        } catch (e) {
          console.error(e);
        }
      }

      function onBarcodeEnter(e) {
        if (e.key === "Enter") {
          const keyword = e.target.value.trim();
          if (!keyword) return;
          searchAndAdd(keyword);
        } else {
          // èŠ‚æµæœç´¢è”æƒ³
          const keyword = e.target.value.trim();
          debounceSuggest(keyword);
        }
      }

      let suggestTimer = null;
      function debounceSuggest(keyword) {
        clearTimeout(suggestTimer);
        suggestTimer = setTimeout(() => loadSuggestions(keyword), 250);
      }

      async function loadSuggestions(keyword) {
        const container = document.getElementById("suggestList");
        if (!keyword) {
          container.innerHTML = "";
          return;
        }
        try {
          const res = await fetch(
            `/api/products/search?keyword=${encodeURIComponent(
              keyword
            )}&limit=8`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "æœç´¢å¤±è´¥");
          const rows = data.data || [];
          if (rows.length === 0) {
            container.innerHTML = "";
            return;
          }
          const listHtml = `
            <div style="position:absolute; background:#fff; border:1px solid #dee2e6; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:6px; z-index:10; max-width:520px;">
              ${rows
                .map(
                  (p) => `
                    <div style="padding:8px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:12px;" onclick='addProduct(${JSON.stringify(
                      p
                    ).replace(/"/g, "&quot;")})'>
                      <span>${p.code || "-"} - ${p.name}</span>
                      <span style="color:#6c757d">Â¥${parseFloat(
                        p.selling_price
                      ).toFixed(2)} / åº“å­˜:${p.stock_quantity || 0}</span>
                    </div>`
                )
                .join("")}
            </div>`;
          container.innerHTML = listHtml;
        } catch (err) {
          console.error(err);
        }
      }

      async function searchAndAdd(keyword) {
        try {
          const res = await fetch(
            `/api/products/search?keyword=${encodeURIComponent(
              keyword
            )}&limit=20`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "æœç´¢å¤±è´¥");
          const rows = data.data || [];
          if (rows.length === 0) {
            showError("æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“", document.getElementById("msgArea"));
            return;
          }
          // ä¼˜å…ˆç²¾ç¡®åŒ¹é…ç¼–ç 
          const exact = rows.find(
            (p) => p.code && p.code.toLowerCase() === keyword.toLowerCase()
          );
          addProduct(exact || rows[0]);
        } catch (err) {
          showError(err.message, document.getElementById("msgArea"));
        } finally {
          const input = document.getElementById("barcodeInput");
          input.value = "";
          input.focus();
          document.getElementById("suggestList").innerHTML = "";
        }
      }

      function addProduct(p) {
        const stock = p.stock_quantity || 0;
        if (stock <= 0) {
          showError(
            "è¯¥å•†å“åº“å­˜ä¸è¶³ï¼Œæ— æ³•åŠ å…¥",
            document.getElementById("msgArea")
          );
          return;
        }
        const exist = cart.find((it) => it.product_id === p.id);
        if (exist) {
          const next = exist.quantity + 1;
          if (next > exist.stock) {
            showError("è¶…è¿‡åº“å­˜ä¸Šé™", document.getElementById("msgArea"));
          } else {
            exist.quantity = next;
          }
        } else {
          cart.push({
            product_id: p.id,
            code: p.code || "",
            name: p.name,
            unit: p.unit || "ä»¶",
            price: parseFloat(p.selling_price || 0),
            stock: stock,
            quantity: 1,
          });
        }
        renderCart();
      }

      function renderCart() {
        const tbody = document.getElementById("cartTableBody");
        if (!cart.length) {
          tbody.innerHTML =
            '<tr><td class="text-center" colspan="8">è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·æ‰«ç æˆ–è¾“å…¥æ·»åŠ </td></tr>';
          updateSummary();
          return;
        }
        tbody.innerHTML = cart
          .map((it) => {
            const subtotal = it.quantity * it.price;
            return `
              <tr>
                <td>${it.code || "-"}</td>
                <td>${it.name}</td>
                <td>${it.unit}</td>
                <td>Â¥${it.price.toFixed(2)}</td>
                <td>${it.stock}</td>
                <td>
                  <div style="display:flex; align-items:center; gap:6px;">
                    <button class="btn-link" title="å‡å°‘" onclick="changeQty(${
                      it.product_id
                    }, -1)">â–</button>
                    <input type="number" min="1" max="${it.stock}" value="${
              it.quantity
            }" style="width:70px; padding:6px;" onchange="setQty(${
              it.product_id
            }, this.value)" />
                    <button class="btn-link" title="å¢åŠ " onclick="changeQty(${
                      it.product_id
                    }, 1)">â•</button>
                  </div>
                </td>
                <td>Â¥${subtotal.toFixed(2)}</td>
                <td><button class="btn-link" title="ç§»é™¤" onclick="removeItem(${
                  it.product_id
                })">ğŸ—‘ï¸</button></td>
              </tr>
            `;
          })
          .join("");
        updateSummary();
      }

      function changeQty(pid, delta) {
        const it = cart.find((x) => x.product_id === pid);
        if (!it) return;
        let val = it.quantity + delta;
        val = Math.max(1, Math.min(it.stock, val));
        it.quantity = val;
        renderCart();
      }

      function setQty(pid, val) {
        const it = cart.find((x) => x.product_id === pid);
        if (!it) return;
        let n = parseInt(val || 1, 10);
        if (isNaN(n)) n = 1;
        n = Math.max(1, Math.min(it.stock, n));
        it.quantity = n;
        renderCart();
      }

      function removeItem(pid) {
        cart = cart.filter((x) => x.product_id !== pid);
        renderCart();
      }

      function clearCart() {
        cart = [];
        renderCart();
        showSuccess("å·²æ¸…ç©ºè´­ç‰©è½¦", document.getElementById("msgArea"));
      }

      function updateSummary() {
        const kinds = cart.length;
        const totalQty = cart.reduce((s, it) => s + it.quantity, 0);
        const totalAmount = cart.reduce(
          (s, it) => s + it.quantity * it.price,
          0
        );
        document.getElementById("itemKinds").textContent = kinds;
        document.getElementById("totalQty").textContent = totalQty;
        document.getElementById(
          "totalAmount"
        ).textContent = `Â¥${totalAmount.toFixed(2)}`;
      }

      async function checkout() {
        if (!cart.length) {
          showError("è´­ç‰©è½¦ä¸ºç©º", document.getElementById("msgArea"));
          return;
        }
        // ç»„è£…æ˜ç»†
        const details = cart.map((it) => ({
          product_id: it.product_id,
          quantity: it.quantity,
          selling_price: it.price,
        }));
        const customerIdValue = document.getElementById("customerSelect").value;
        const payload = {
          sale_date: formatDate(new Date()),
          details,
          remark: document.getElementById("orderRemark").value.trim(),
        };
        if (customerIdValue) {
          payload.customer_id = parseInt(customerIdValue, 10);
        }
        try {
          const res = await fetch("/api/outgoing-orders", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "ä¸‹å•å¤±è´¥");
          showSuccess(
            `ä¸‹å•æˆåŠŸï¼Œè®¢å•å·ï¼š${data.data.order_no}ï¼Œåˆè®¡ï¼šÂ¥${parseFloat(
              data.data.total_amount || 0
            ).toFixed(2)}`,
            document.getElementById("msgArea")
          );
          // é€‰é¡¹ï¼šä¸‹å•åæ‰“å°å°ç¥¨
          const printChecked =
            document.getElementById("printAfterCheckout")?.checked;
          if (printChecked && data.data && data.data.order_id) {
            const url = `/printing/receipt/${data.data.order_id}`;
            window.open(url, "_blank");
          }
          clearCart();
          document.getElementById("barcodeInput").focus();
        } catch (err) {
          showError(err.message, document.getElementById("msgArea"));
        }
      }
    </script>
  </body>
</html>
