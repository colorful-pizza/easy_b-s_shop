<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>商品销售 - 便利店进销存系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- 顶部导航栏 -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>便利店进销存系统</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >返回首页</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">退出登录</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- 侧边栏 -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- 菜单项将通过JavaScript动态生成 -->
          </ul>
        </nav>
      </aside>

      <!-- 主内容区域 -->
      <main class="content">
        <div class="content-header">
          <h2>商品销售</h2>
          <div class="breadcrumb">
            <span>首页 > 商品销售</span>
          </div>
        </div>

        <div class="content-body">
          <!-- 提示区域 -->
          <div id="msgArea"></div>

          <!-- 操作栏：扫码/输入条码加入购物车 -->
          <div class="action-bar">
            <div
              class="search-container"
              style="flex-wrap: wrap; row-gap: 10px"
            >
              <input
                type="text"
                class="search-input"
                id="barcodeInput"
                placeholder="扫码/输入条码或名称后按回车添加到购物车"
                style="width: 420px; font-size: 16px"
              />
              <div id="suggestList" style="position: relative; width: 100%">
                <!-- 简易联想结果（可点击加入）将插入到此处 -->
              </div>
            </div>
            <div>
              <select
                id="customerSelect"
                class="filter-select"
                title="选择客户"
              >
                <option value="">选择客户（默认散户）</option>
              </select>
              <input
                type="text"
                id="orderRemark"
                class="search-input"
                placeholder="订单备注（可选）"
                style="width: 220px"
              />
              <button class="btn btn-secondary" onclick="clearCart()">
                清空购物车
              </button>
              <label
                style="margin-left: 10px; margin-right: 6px; user-select: none"
              >
                <input type="checkbox" id="printAfterCheckout" checked />
                下单后打印小票
              </label>
              <button class="btn btn-primary" onclick="checkout()">
                结算下单
              </button>
            </div>
          </div>

          <!-- 购物车表格 -->
          <div class="table-container">
            <table class="data-table" id="cartTable">
              <thead>
                <tr>
                  <th style="width: 140px">商品编码</th>
                  <th>商品名称</th>
                  <th style="width: 80px">单位</th>
                  <th style="width: 100px">单价</th>
                  <th style="width: 100px">库存</th>
                  <th style="width: 180px">数量</th>
                  <th style="width: 120px">小计</th>
                  <th style="width: 80px">操作</th>
                </tr>
              </thead>
              <tbody id="cartTableBody">
                <tr>
                  <td class="text-center" colspan="8">
                    购物车为空，请扫码或输入添加
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 合计区域 -->
          <div class="pagination-container" style="justify-content: flex-end">
            <div
              class="page-info"
              style="display: flex; gap: 20px; align-items: center"
            >
              <span>商品种类：<b id="itemKinds">0</b></span>
              <span>总数量：<b id="totalQty">0</b></span>
              <span>合计金额：<b id="totalAmount">¥0.00</b></span>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // 购物车数据结构：[{ product_id, code, name, unit, price, stock, quantity }]
      let cart = [];
      let customers = [];

      // 页面初始化
      document.addEventListener("DOMContentLoaded", function () {
        initCommonPage("sales");
        const input = document.getElementById("barcodeInput");
        input.addEventListener("keydown", onBarcodeEnter);
        input.focus();
        loadCustomers();
      });

      async function loadCustomers() {
        try {
          const res = await fetch(
            `/api/customers/search?limit=500&include_default=true`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "加载客户失败");
          customers = data.data || [];
          const sel = document.getElementById("customerSelect");
          // 清空并重建
          sel.innerHTML =
            '<option value="">选择客户（默认散户）</option>' +
            customers
              .map(
                (c) =>
                  `<option value="${c.id}">${c.name}${
                    c.is_default ? "（散户）" : ""
                  }</option>`
              )
              .join("");
          // 默认选中散户
          const def = customers.find((c) => c.is_default);
          if (def) sel.value = String(def.id);
        } catch (e) {
          console.error(e);
        }
      }

      function onBarcodeEnter(e) {
        if (e.key === "Enter") {
          const keyword = e.target.value.trim();
          if (!keyword) return;
          searchAndAdd(keyword);
        } else {
          // 节流搜索联想
          const keyword = e.target.value.trim();
          debounceSuggest(keyword);
        }
      }

      let suggestTimer = null;
      function debounceSuggest(keyword) {
        clearTimeout(suggestTimer);
        suggestTimer = setTimeout(() => loadSuggestions(keyword), 250);
      }

      async function loadSuggestions(keyword) {
        const container = document.getElementById("suggestList");
        if (!keyword) {
          container.innerHTML = "";
          return;
        }
        try {
          const res = await fetch(
            `/api/products/search?keyword=${encodeURIComponent(
              keyword
            )}&limit=8`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "搜索失败");
          const rows = data.data || [];
          if (rows.length === 0) {
            container.innerHTML = "";
            return;
          }
          const listHtml = `
            <div style="position:absolute; background:#fff; border:1px solid #dee2e6; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:6px; z-index:10; max-width:520px;">
              ${rows
                .map(
                  (p) => `
                    <div style="padding:8px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:12px;" onclick='addProduct(${JSON.stringify(
                      p
                    ).replace(/"/g, "&quot;")})'>
                      <span>${p.code || "-"} - ${p.name}</span>
                      <span style="color:#6c757d">¥${parseFloat(
                        p.selling_price
                      ).toFixed(2)} / 库存:${p.stock_quantity || 0}</span>
                    </div>`
                )
                .join("")}
            </div>`;
          container.innerHTML = listHtml;
        } catch (err) {
          console.error(err);
        }
      }

      async function searchAndAdd(keyword) {
        try {
          const res = await fetch(
            `/api/products/search?keyword=${encodeURIComponent(
              keyword
            )}&limit=20`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "搜索失败");
          const rows = data.data || [];
          if (rows.length === 0) {
            showError("未找到匹配的商品", document.getElementById("msgArea"));
            return;
          }
          // 优先精确匹配编码
          const exact = rows.find(
            (p) => p.code && p.code.toLowerCase() === keyword.toLowerCase()
          );
          addProduct(exact || rows[0]);
        } catch (err) {
          showError(err.message, document.getElementById("msgArea"));
        } finally {
          const input = document.getElementById("barcodeInput");
          input.value = "";
          input.focus();
          document.getElementById("suggestList").innerHTML = "";
        }
      }

      function addProduct(p) {
        const stock = p.stock_quantity || 0;
        if (stock <= 0) {
          showError(
            "该商品库存不足，无法加入",
            document.getElementById("msgArea")
          );
          return;
        }
        const exist = cart.find((it) => it.product_id === p.id);
        if (exist) {
          const next = exist.quantity + 1;
          if (next > exist.stock) {
            showError("超过库存上限", document.getElementById("msgArea"));
          } else {
            exist.quantity = next;
          }
        } else {
          cart.push({
            product_id: p.id,
            code: p.code || "",
            name: p.name,
            unit: p.unit || "件",
            price: parseFloat(p.selling_price || 0),
            stock: stock,
            quantity: 1,
          });
        }
        renderCart();
      }

      function renderCart() {
        const tbody = document.getElementById("cartTableBody");
        if (!cart.length) {
          tbody.innerHTML =
            '<tr><td class="text-center" colspan="8">购物车为空，请扫码或输入添加</td></tr>';
          updateSummary();
          return;
        }
        tbody.innerHTML = cart
          .map((it) => {
            const subtotal = it.quantity * it.price;
            return `
              <tr>
                <td>${it.code || "-"}</td>
                <td>${it.name}</td>
                <td>${it.unit}</td>
                <td>¥${it.price.toFixed(2)}</td>
                <td>${it.stock}</td>
                <td>
                  <div style="display:flex; align-items:center; gap:6px;">
                    <button class="btn-link" title="减少" onclick="changeQty(${
                      it.product_id
                    }, -1)">➖</button>
                    <input type="number" min="1" max="${it.stock}" value="${
              it.quantity
            }" style="width:70px; padding:6px;" onchange="setQty(${
              it.product_id
            }, this.value)" />
                    <button class="btn-link" title="增加" onclick="changeQty(${
                      it.product_id
                    }, 1)">➕</button>
                  </div>
                </td>
                <td>¥${subtotal.toFixed(2)}</td>
                <td><button class="btn-link" title="移除" onclick="removeItem(${
                  it.product_id
                })">🗑️</button></td>
              </tr>
            `;
          })
          .join("");
        updateSummary();
      }

      function changeQty(pid, delta) {
        const it = cart.find((x) => x.product_id === pid);
        if (!it) return;
        let val = it.quantity + delta;
        val = Math.max(1, Math.min(it.stock, val));
        it.quantity = val;
        renderCart();
      }

      function setQty(pid, val) {
        const it = cart.find((x) => x.product_id === pid);
        if (!it) return;
        let n = parseInt(val || 1, 10);
        if (isNaN(n)) n = 1;
        n = Math.max(1, Math.min(it.stock, n));
        it.quantity = n;
        renderCart();
      }

      function removeItem(pid) {
        cart = cart.filter((x) => x.product_id !== pid);
        renderCart();
      }

      function clearCart() {
        cart = [];
        renderCart();
        showSuccess("已清空购物车", document.getElementById("msgArea"));
      }

      function updateSummary() {
        const kinds = cart.length;
        const totalQty = cart.reduce((s, it) => s + it.quantity, 0);
        const totalAmount = cart.reduce(
          (s, it) => s + it.quantity * it.price,
          0
        );
        document.getElementById("itemKinds").textContent = kinds;
        document.getElementById("totalQty").textContent = totalQty;
        document.getElementById(
          "totalAmount"
        ).textContent = `¥${totalAmount.toFixed(2)}`;
      }

      async function checkout() {
        if (!cart.length) {
          showError("购物车为空", document.getElementById("msgArea"));
          return;
        }
        // 组装明细
        const details = cart.map((it) => ({
          product_id: it.product_id,
          quantity: it.quantity,
          selling_price: it.price,
        }));
        const customerIdValue = document.getElementById("customerSelect").value;
        const payload = {
          sale_date: formatDate(new Date()),
          details,
          remark: document.getElementById("orderRemark").value.trim(),
        };
        if (customerIdValue) {
          payload.customer_id = parseInt(customerIdValue, 10);
        }
        try {
          const res = await fetch("/api/outgoing-orders", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "下单失败");
          showSuccess(
            `下单成功，订单号：${data.data.order_no}，合计：¥${parseFloat(
              data.data.total_amount || 0
            ).toFixed(2)}`,
            document.getElementById("msgArea")
          );
          // 选项：下单后打印小票
          const printChecked =
            document.getElementById("printAfterCheckout")?.checked;
          if (printChecked && data.data && data.data.order_id) {
            const url = `/printing/receipt/${data.data.order_id}`;
            window.open(url, "_blank");
          }
          clearCart();
          document.getElementById("barcodeInput").focus();
        } catch (err) {
          showError(err.message, document.getElementById("msgArea"));
        }
      }
    </script>
  </body>
</html>
