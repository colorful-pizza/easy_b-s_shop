<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‡‡è´­ç®¡ç† - ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <h1>ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿ</h1>
        </div>
        <div class="navbar-user">
          <a href="/" class="btn btn-secondary" style="margin-right: 10px"
            >è¿”å›é¦–é¡µ</a
          >
          <span id="userInfo"></span>
          <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul id="menuList">
            <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <main class="content">
        <div class="content-header">
          <h2>é‡‡è´­ç®¡ç†</h2>
          <div class="breadcrumb">
            <span>é¦–é¡µ > é‡‡è´­ç®¡ç†</span>
          </div>
        </div>

        <div class="content-body">
          <!-- æ“ä½œæ  -->
          <div class="action-bar">
            <button class="btn btn-primary" onclick="openCreateOrderModal()">
              <i class="icon-plus"></i> æ–°å¢é‡‡è´­è®¢å•
            </button>
            <div class="search-container">
              <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="æœç´¢è®¢å•å·ã€ä¾›åº”å•†ã€ç”³è¯·äºº"
                onkeyup="handleSearch()"
              />
              <select
                class="filter-select"
                id="statusFilter"
                onchange="handleFilter()"
              >
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="pending">å¾…å®š</option>
                <option value="approved">å·²æ‰¹å‡†</option>
                <option value="stock">å·²å…¥åº“</option>
                <option value="delivered">å·²äº¤ä»˜</option>
                <option value="paid">å·²ä»˜æ¬¾</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
              </select>
              <select
                class="filter-select"
                id="supplierFilter"
                onchange="handleFilter()"
              >
                <option value="">æ‰€æœ‰ä¾›åº”å•†</option>
                <!-- åŠ¨æ€åŠ è½½ä¾›åº”å•†é€‰é¡¹ -->
              </select>
            </div>
          </div>

          <!-- æ•°æ®è¡¨æ ¼ -->
          <div class="table-container">
            <table class="data-table" id="purchaseTable">
              <thead>
                <tr>
                  <th>è®¢å•å·</th>
                  <th>ä¾›åº”å•†</th>
                  <th>çŠ¶æ€</th>
                  <th>æ€»é‡‘é¢</th>
                  <th>ç”³è¯·äºº</th>
                  <th>ç”³è¯·æ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="purchaseTableBody">
                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
              </tbody>
            </table>
          </div>

          <!-- åˆ†é¡µæ§ä»¶ -->
          <div class="pagination-container">
            <div class="page-info">
              <span id="pageInfo">å…± 0 æ¡è®°å½•</span>
            </div>
            <div class="pagination" id="pagination">
              <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘é‡‡è´­è®¢å•æ¨¡æ€æ¡† -->
    <div id="orderModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="orderModalTitle">æ–°å¢é‡‡è´­è®¢å•</h3>
          <span class="close" onclick="closeOrderModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="orderForm">
            <input type="hidden" id="orderId" name="id" />

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-row">
              <div class="form-group">
                <label for="supplierSelect">ä¾›åº”å•† *</label>
                <select id="supplierSelect" name="supplier_id" required>
                  <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
                  <!-- åŠ¨æ€åŠ è½½ä¾›åº”å•†é€‰é¡¹ -->
                </select>
              </div>
              <div class="form-group">
                <label for="orderRemark">å¤‡æ³¨</label>
                <textarea
                  id="orderRemark"
                  name="remark"
                  placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"
                ></textarea>
              </div>
            </div>

            <!-- å•†å“æ˜ç»† -->
            <div class="form-group">
              <label>å•†å“æ˜ç»†</label>
              <div class="products-section">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="openProductSelector()"
                >
                  <i class="icon-plus"></i> æ·»åŠ å•†å“
                </button>
                <div class="products-table-container">
                  <table class="products-table" id="productsTable">
                    <thead>
                      <tr>
                        <th>å•†å“ç¼–ç </th>
                        <th>å•†å“åç§°</th>
                        <th>å•ä½</th>
                        <th>é‡‡è´­æ•°é‡</th>
                        <th>é‡‡è´­å•ä»·</th>
                        <th>å°è®¡</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="productsTableBody">
                      <!-- å•†å“æ˜ç»†å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                  </table>
                </div>
                <div class="total-section">
                  <span class="total-label">è®¢å•æ€»é‡‘é¢ï¼š</span>
                  <span class="total-amount" id="totalAmount">ï¿¥0.00</span>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeOrderModal()"
          >
            å–æ¶ˆ
          </button>
          <button type="button" class="btn btn-primary" onclick="saveOrder()">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- å•†å“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="productSelectorModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>é€‰æ‹©é‡‡è´­å•†å“</h3>
          <span class="close" onclick="closeProductSelector()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="search-container">
            <input
              type="text"
              class="search-input"
              id="productSearchInput"
              placeholder="æœç´¢å•†å“åç§°æˆ–ç¼–ç "
              onkeyup="handleProductSearch()"
            />
            <select
              class="filter-select"
              id="categoryFilter"
              onchange="handleProductFilter()"
            >
              <option value="">æ‰€æœ‰åˆ†ç±»</option>
              <!-- åŠ¨æ€åŠ è½½åˆ†ç±»é€‰é¡¹ -->
            </select>
          </div>

          <div class="products-list" id="productsList">
            <!-- å•†å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeProductSelector()"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="orderDetailModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>é‡‡è´­è®¢å•è¯¦æƒ…</h3>
          <span class="close" onclick="closeOrderDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div id="orderDetailContent">
            <!-- è®¢å•è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeOrderDetailModal()"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- åŠ è½½è¦†ç›–å±‚ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
      // å…¨å±€å˜é‡
      let currentPage = 1;
      let pageSize = 10;
      let searchQuery = "";
      let statusFilter = "";
      let supplierFilter = "";
      let suppliers = [];
      let categories = [];
      let products = [];
      let selectedProducts = [];
      let isEditMode = false;
      let currentOrderId = null;

      // çŠ¶æ€æ˜ å°„
      const statusMap = {
        pending: { text: "å¾…å®š", class: "status-pending" },
        approved: { text: "å·²æ‰¹å‡†", class: "status-approved" },
        delivered: { text: "å·²äº¤ä»˜", class: "status-delivered" },
        stock: { text: "å·²å…¥åº“", class: "status-stock" },
        paid: { text: "å·²ä»˜æ¬¾", class: "status-paid" },
        cancelled: { text: "å·²å–æ¶ˆ", class: "status-cancelled" },
      };

      // é¡µé¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initCommonPage("purchase");
        loadInitialData();
      });

      // åŠ è½½åˆå§‹æ•°æ®
      async function loadInitialData() {
        await Promise.all([
          loadSuppliers(),
          loadCategories(),
          loadProducts(),
          loadPurchaseOrders(),
        ]);
      }

      // åŠ è½½ä¾›åº”å•†åˆ—è¡¨
      async function loadSuppliers() {
        try {
          const response = await fetch(
            "/api/suppliers?size=1000&status=active",
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await response.json();

          if (data.success) {
            suppliers = data.data;
            updateSupplierSelects();
          }
        } catch (error) {
          console.error("åŠ è½½ä¾›åº”å•†å¤±è´¥:", error);
        }
      }

      // æ›´æ–°ä¾›åº”å•†ä¸‹æ‹‰æ¡†
      function updateSupplierSelects() {
        const supplierSelect = document.getElementById("supplierSelect");
        const supplierFilter = document.getElementById("supplierFilter");

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        supplierSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>';
        supplierFilter.innerHTML = '<option value="">æ‰€æœ‰ä¾›åº”å•†</option>';

        // æ·»åŠ ä¾›åº”å•†é€‰é¡¹
        suppliers.forEach((supplier) => {
          const option1 = new Option(supplier.name, supplier.id);
          const option2 = new Option(supplier.name, supplier.id);
          supplierSelect.appendChild(option1);
          supplierFilter.appendChild(option2);
        });
      }

      // åŠ è½½å•†å“åˆ†ç±»
      async function loadCategories() {
        try {
          const response = await fetch("/api/categories", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await response.json();

          if (data.success) {
            categories = data.data;
            updateCategorySelect();
          }
        } catch (error) {
          console.error("åŠ è½½åˆ†ç±»å¤±è´¥:", error);
        }
      }

      // æ›´æ–°åˆ†ç±»ä¸‹æ‹‰æ¡†
      function updateCategorySelect() {
        const categoryFilter = document.getElementById("categoryFilter");
        categoryFilter.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>';

        categories.forEach((category) => {
          const option = new Option(category.name, category.id);
          categoryFilter.appendChild(option);
        });
      }

      // åŠ è½½å•†å“åˆ—è¡¨
      async function loadProducts() {
        try {
          const response = await fetch(
            "/api/products?size=1000&status=active",
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const data = await response.json();

          if (data.success) {
            products = data.data;
          }
        } catch (error) {
          console.error("åŠ è½½å•†å“å¤±è´¥:", error);
        }
      }

      // åŠ è½½é‡‡è´­è®¢å•åˆ—è¡¨
      async function loadPurchaseOrders() {
        showLoading();
        try {
          const params = new URLSearchParams({
            page: currentPage,
            size: pageSize,
          });

          if (searchQuery) params.append("search", searchQuery);
          if (statusFilter) params.append("status", statusFilter);
          if (supplierFilter) params.append("supplier_id", supplierFilter);

          const response = await fetch(`/api/purchase-orders?${params}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await response.json();

          if (data.success) {
            renderPurchaseTable(data.data);
            renderPagination(data.pagination);
          } else {
            showError(data.message || "åŠ è½½é‡‡è´­è®¢å•å¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // æ¸²æŸ“é‡‡è´­è®¢å•è¡¨æ ¼
      function renderPurchaseTable(orders) {
        const tbody = document.getElementById("purchaseTableBody");

        if (orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">æš‚æ— æ•°æ®</td></tr>';
          return;
        }

        tbody.innerHTML = orders
          .map(
            (order) => `
          <tr>
            <td>${order.order_no}</td>
            <td>${order.supplier_name || "æœªçŸ¥ä¾›åº”å•†"}</td>
            <td>
              <span class="status-badge ${
                statusMap[order.status]?.class || "status-unknown"
              }">
                ${statusMap[order.status]?.text || order.status}
              </span>
            </td>
            <td>ï¿¥${parseFloat(order.total_amount || 0).toFixed(2)}</td>
            <td>${order.apply_user_name || "æœªçŸ¥ç”¨æˆ·"}</td>
            <td>${order.apply_time || ""}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-link" onclick="viewOrderDetail(${
                  order.id
                })" title="æŸ¥çœ‹è¯¦æƒ…">
                  ğŸ‘ï¸
                </button>
                ${
                  order.status === "pending"
                    ? `
                  <button class="btn-link" onclick="editOrder(${order.id})" title="ç¼–è¾‘">
                    âœï¸
                  </button>
                  <button class="btn-link" onclick="deleteOrder(${order.id})" title="åˆ é™¤">
                    ğŸ—‘ï¸
                  </button>
                `
                    : ""
                }
                ${getNextStepButton(order)}
                ${getPrintButton(order)}
                ${
                  order.status === "pending" || order.status === "approved"
                    ? `
                  <button class="btn-link" onclick="cancelOrder(${order.id})" title="å–æ¶ˆ">
                    âŒ
                  </button>
                `
                    : ""
                }
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // è·å–ä¸‹ä¸€æ­¥æŒ‰é’®
      function getNextStepButton(order) {
        switch (order.status) {
          case "pending":
            return `<button class="btn-link" onclick="nextStep(${order.id}, 'approve')" title="æ‰¹å‡†">âœ…</button>`;
          case "approved":
            return `<button class="btn-link" onclick="nextStep(${order.id}, 'deliver')" title="æ ‡è®°ä¸ºå·²äº¤ä»˜">ğŸ“¦</button>`;
          default:
            return "";
        }
      }

      // è·å–æ‰“å°æŒ‰é’®ï¼špending æ‰“å°ç”³è¯·å•ï¼Œapproved æ‰“å°é‡‡è´­è®¢å•
      function getPrintButton(order) {
        if (order.status === "pending") {
          return `<button class="btn-link" onclick="printPurchase(${order.id}, 'pending')" title="æ‰“å°ç”³è¯·å•">ğŸ–¨ï¸</button>`;
        }
        if (order.status === "approved") {
          return `<button class="btn-link" onclick="printPurchase(${order.id}, 'approved')" title="æ‰“å°é‡‡è´­è®¢å•">ğŸ–¨ï¸</button>`;
        }
        return "";
      }

      // æ‰“å°å¤„ç†ï¼šæ‰“å¼€æ–°çª—å£åˆ°æ‰“å°é¡µ
      function printPurchase(orderId, status) {
        let url = "";
        if (status === "pending") {
          url = `/printing/purchase/apply/${orderId}`;
        } else if (status === "approved") {
          url = `/printing/purchase/order/${orderId}`;
        } else {
          return;
        }
        window.open(url, "_blank");
      }

      // æ¸²æŸ“åˆ†é¡µæ§ä»¶
      function renderPagination(pagination) {
        document.getElementById(
          "pageInfo"
        ).textContent = `å…± ${pagination.total} æ¡è®°å½•ï¼Œç¬¬ ${pagination.page} / ${pagination.total_pages} é¡µ`;

        const paginationEl = document.getElementById("pagination");
        let paginationHTML = "";

        // ä¸Šä¸€é¡µ
        if (pagination.has_prev) {
          paginationHTML += `<button class="page-btn" onclick="changePage(${
            pagination.page - 1
          })">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç 
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.page + 2);

        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `<button class="page-btn ${
            i === pagination.page ? "active" : ""
          }" onclick="changePage(${i})">${i}</button>`;
        }

        // ä¸‹ä¸€é¡µ
        if (pagination.has_next) {
          paginationHTML += `<button class="page-btn" onclick="changePage(${
            pagination.page + 1
          })">ä¸‹ä¸€é¡µ</button>`;
        }

        paginationEl.innerHTML = paginationHTML;
      }

      // é¡µé¢è·³è½¬
      function changePage(page) {
        currentPage = page;
        loadPurchaseOrders();
      }

      // æœç´¢å¤„ç†
      function handleSearch() {
        searchQuery = document.getElementById("searchInput").value.trim();
        currentPage = 1;
        loadPurchaseOrders();
      }

      // ç­›é€‰å¤„ç†
      function handleFilter() {
        statusFilter = document.getElementById("statusFilter").value;
        supplierFilter = document.getElementById("supplierFilter").value;
        currentPage = 1;
        loadPurchaseOrders();
      }

      // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      // æ‰“å¼€æ–°å¢è®¢å•æ¨¡æ€æ¡†
      function openCreateOrderModal() {
        isEditMode = false;
        currentOrderId = null;
        document.getElementById("orderModalTitle").textContent = "æ–°å¢é‡‡è´­è®¢å•";
        document.getElementById("orderForm").reset();
        document.getElementById("orderId").value = "";
        selectedProducts = [];
        renderProductsTable();
        updateTotalAmount();
        document.getElementById("orderModal").style.display = "flex";
      }

      // å…³é—­è®¢å•æ¨¡æ€æ¡†
      function closeOrderModal() {
        document.getElementById("orderModal").style.display = "none";
      }

      // ç¼–è¾‘è®¢å•
      async function editOrder(orderId) {
        try {
          const response = await fetch(`/api/purchase-orders/${orderId}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await response.json();

          if (data.success) {
            isEditMode = true;
            currentOrderId = orderId;

            // å¡«å……è¡¨å•
            document.getElementById("orderModalTitle").textContent =
              "ç¼–è¾‘é‡‡è´­è®¢å•";
            document.getElementById("orderId").value = data.data.order.id;
            document.getElementById("supplierSelect").value =
              data.data.order.supplier_id;
            document.getElementById("orderRemark").value =
              data.data.order.remark || "";

            // å¡«å……å•†å“æ˜ç»†
            selectedProducts = data.data.details.map((detail) => ({
              id: detail.product_id,
              code: detail.code,
              name: detail.product_name,
              unit: detail.unit,
              quantity: detail.quantity,
              cost_price: detail.cost_price,
              amount: detail.amount,
              remark: detail.remark,
            }));

            renderProductsTable();
            updateTotalAmount();
            document.getElementById("orderModal").style.display = "flex";
          } else {
            showError(data.message || "è·å–è®¢å•è¯¦æƒ…å¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // æŸ¥çœ‹è®¢å•è¯¦æƒ…
      async function viewOrderDetail(orderId) {
        try {
          const response = await fetch(`/api/purchase-orders/${orderId}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await response.json();

          if (data.success) {
            // åç«¯è¿”å›çš„æ•°æ®ç»“æ„æ˜¯ { data: { order: {...}, details: [...] } }
            // éœ€è¦é‡æ–°ç»„ç»‡æ•°æ®ç»“æ„
            const orderData = {
              ...data.data.order,
              details: data.data.details,
            };
            renderOrderDetail(orderData);
            document.getElementById("orderDetailModal").style.display = "flex";
          } else {
            showError(data.message || "è·å–è®¢å•è¯¦æƒ…å¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // æ¸²æŸ“è®¢å•è¯¦æƒ…
      function renderOrderDetail(order) {
        const content = document.getElementById("orderDetailContent");
        content.innerHTML = `
          <div class="order-detail">
            <div class="detail-section">
              <h4>åŸºæœ¬ä¿¡æ¯</h4>
              <div class="detail-row">
                <label>è®¢å•å·:</label>
                <span>${order.order_no}</span>
              </div>
              <div class="detail-row">
                <label>ä¾›åº”å•†:</label>
                <span>${order.supplier_name || "æœªçŸ¥ä¾›åº”å•†"}</span>
              </div>
              <div class="detail-row">
                <label>çŠ¶æ€:</label>
                <span class="status-badge ${
                  statusMap[order.status]?.class || "status-unknown"
                }">
                  ${statusMap[order.status]?.text || order.status}
                </span>
              </div>
              <div class="detail-row">
                <label>æ€»é‡‘é¢:</label>
                <span>ï¿¥${parseFloat(order.total_amount || 0).toFixed(2)}</span>
              </div>
              <div class="detail-row">
                <label>ç”³è¯·äºº:</label>
                <span>${order.apply_user_name || "æœªçŸ¥ç”¨æˆ·"}</span>
              </div>
              <div class="detail-row">
                <label>ç”³è¯·æ—¶é—´:</label>
                <span>${order.apply_time || ""}</span>
              </div>
              ${
                order.approve_user_name
                  ? `
                <div class="detail-row">
                  <label>æ‰¹å‡†äºº:</label>
                  <span>${order.approve_user_name}</span>
                </div>
                <div class="detail-row">
                  <label>æ‰¹å‡†æ—¶é—´:</label>
                  <span>${order.approve_time || ""}</span>
                </div>
              `
                  : ""
              }
              ${
                order.remark
                  ? `
                <div class="detail-row">
                  <label>å¤‡æ³¨:</label>
                  <span>${order.remark}</span>
                </div>
              `
                  : ""
              }
            </div>
            
            <div class="detail-section">
              <h4>å•†å“æ˜ç»†</h4>
              <table class="detail-table">
                <thead>
                  <tr>
                    <th>å•†å“ç¼–ç </th>
                    <th>å•†å“åç§°</th>
                    <th>å•ä½</th>
                    <th>æ•°é‡</th>
                    <th>å•ä»·</th>
                    <th>å°è®¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${order.details
                    .map(
                      (detail) => `
                    <tr>
                      <td>${detail.code}</td>
                      <td>${detail.product_name}</td>
                      <td>${detail.unit}</td>
                      <td>${detail.quantity}</td>
                      <td>ï¿¥${parseFloat(detail.cost_price).toFixed(2)}</td>
                      <td>ï¿¥${parseFloat(detail.amount).toFixed(2)}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // å…³é—­è®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
      function closeOrderDetailModal() {
        document.getElementById("orderDetailModal").style.display = "none";
      }

      // ä¸‹ä¸€æ­¥æ“ä½œ
      async function nextStep(orderId, action) {
        const confirmMessages = {
          approve: "ç¡®å®šè¦æ‰¹å‡†è¿™ä¸ªé‡‡è´­è®¢å•å—ï¼Ÿ",
          deliver: "ç¡®å®šè¦æ ‡è®°ä¸ºå·²äº¤ä»˜å—ï¼Ÿ",
        };

        if (!confirm(confirmMessages[action])) return;

        try {
          const endpoint = action === "approve" ? "approve" : "deliver";
          const response = await fetch(
            `/api/purchase-orders/${orderId}/${endpoint}`,
            {
              method: "PUT",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();
          if (data.success) {
            showSuccess(data.message || "æ“ä½œæˆåŠŸ");
            loadPurchaseOrders();
          } else {
            showError(data.message || "æ“ä½œå¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // å–æ¶ˆè®¢å•
      async function cancelOrder(orderId) {
        if (!confirm("ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé‡‡è´­è®¢å•å—ï¼Ÿ")) return;

        try {
          const response = await fetch(
            `/api/purchase-orders/${orderId}/reject`,
            {
              method: "PUT",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();
          if (data.success) {
            showSuccess("è®¢å•å·²å–æ¶ˆ");
            loadPurchaseOrders();
          } else {
            showError(data.message || "å–æ¶ˆå¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // åˆ é™¤è®¢å•
      async function deleteOrder(orderId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‡‡è´­è®¢å•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼")) return;

        try {
          const response = await fetch(`/api/purchase-orders/${orderId}`, {
            method: "DELETE",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          const data = await response.json();
          if (data.success) {
            showSuccess("è®¢å•å·²åˆ é™¤");
            loadPurchaseOrders();
          } else {
            showError(data.message || "åˆ é™¤å¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // ä¿å­˜è®¢å•
      async function saveOrder() {
        const form = document.getElementById("orderForm");
        const formData = new FormData(form);

        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!formData.get("supplier_id")) {
          showError("è¯·é€‰æ‹©ä¾›åº”å•†");
          return;
        }

        if (selectedProducts.length === 0) {
          showError("è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå•†å“");
          return;
        }

        // éªŒè¯å•†å“æ•°æ®
        for (let product of selectedProducts) {
          if (!product.quantity || product.quantity <= 0) {
            showError(`å•†å“ ${product.name} çš„æ•°é‡å¿…é¡»å¤§äº0`);
            return;
          }
          if (!product.cost_price || product.cost_price <= 0) {
            showError(`å•†å“ ${product.name} çš„å•ä»·å¿…é¡»å¤§äº0`);
            return;
          }
        }

        try {
          showLoading();

          const orderData = {
            supplier_id: parseInt(formData.get("supplier_id")),
            remark: formData.get("remark"),
            details: selectedProducts.map((product) => ({
              product_id: product.id,
              quantity: product.quantity,
              cost_price: product.cost_price,
              remark: product.remark || "",
            })),
          };

          const url = isEditMode
            ? `/api/purchase-orders/${currentOrderId}`
            : "/api/purchase-orders";
          const method = isEditMode ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          });

          const data = await response.json();
          if (data.success) {
            showSuccess(isEditMode ? "è®¢å•æ›´æ–°æˆåŠŸ" : "è®¢å•åˆ›å»ºæˆåŠŸ");
            closeOrderModal();
            loadPurchaseOrders();
          } else {
            showError(data.message || "ä¿å­˜å¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // æ‰“å¼€å•†å“é€‰æ‹©å™¨
      function openProductSelector() {
        renderProductsList();
        document.getElementById("productSelectorModal").style.display = "flex";
      }

      // å…³é—­å•†å“é€‰æ‹©å™¨
      function closeProductSelector() {
        document.getElementById("productSelectorModal").style.display = "none";
      }

      // æ¸²æŸ“å•†å“åˆ—è¡¨
      function renderProductsList() {
        const searchQuery = document
          .getElementById("productSearchInput")
          .value.toLowerCase();
        const categoryFilter = document.getElementById("categoryFilter").value;

        let filteredProducts = products.filter((product) => {
          const matchSearch =
            product.name.toLowerCase().includes(searchQuery) ||
            product.code.toLowerCase().includes(searchQuery);
          const matchCategory =
            !categoryFilter || product.category_id == categoryFilter;
          const notSelected = !selectedProducts.find(
            (p) => p.id === product.id
          );

          return matchSearch && matchCategory && notSelected;
        });

        const productsList = document.getElementById("productsList");
        productsList.innerHTML = filteredProducts
          .map(
            (product) => `
          <div class="product-item" onclick="selectProduct(${product.id})">
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-code">ç¼–ç : ${product.code}</div>
              <div class="product-price">å½“å‰å”®ä»·: ï¿¥${parseFloat(
                product.sale_price || 0
              ).toFixed(2)}</div>
              <div class="product-stock">åº“å­˜: ${product.stock_quantity || 0} ${
              product.unit
            }</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // å•†å“æœç´¢
      function handleProductSearch() {
        renderProductsList();
      }

      // å•†å“ç­›é€‰
      function handleProductFilter() {
        renderProductsList();
      }

      // é€‰æ‹©å•†å“
      function selectProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (product) {
          const newProduct = {
            id: product.id,
            code: product.code,
            name: product.name,
            unit: product.unit,
            quantity: 1,
            cost_price: parseFloat(product.cost_price || 0),
            amount: parseFloat(product.cost_price || 0),
            remark: "",
          };

          selectedProducts.push(newProduct);
          renderProductsTable();
          updateTotalAmount();
          renderProductsList(); // åˆ·æ–°åˆ—è¡¨ï¼Œç§»é™¤å·²é€‰å•†å“
        }
      }

      // æ¸²æŸ“å•†å“è¡¨æ ¼
      function renderProductsTable() {
        const tbody = document.getElementById("productsTableBody");

        if (selectedProducts.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">æš‚æœªæ·»åŠ å•†å“</td></tr>';
          return;
        }

        tbody.innerHTML = selectedProducts
          .map(
            (product, index) => `
          <tr>
            <td>${product.code}</td>
            <td>${product.name}</td>
            <td>${product.unit}</td>
            <td>
              <input type="number" class="form-input-small" value="${
                product.quantity
              }" 
                     min="1" step="1" onchange="updateProductQuantity(${index}, this.value)">
            </td>
            <td>
              <input type="number" class="form-input-small" value="${
                product.cost_price
              }" 
                     min="0" step="0.01" onchange="updateProductPrice(${index}, this.value)">
            </td>
            <td>ï¿¥${parseFloat(product.amount).toFixed(2)}</td>
            <td>
              <button class="btn-link" onclick="removeProduct(${index})" title="ç§»é™¤">
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // æ›´æ–°å•†å“æ•°é‡
      function updateProductQuantity(index, quantity) {
        const qty = parseFloat(quantity) || 0;
        selectedProducts[index].quantity = qty;
        selectedProducts[index].amount =
          qty * selectedProducts[index].cost_price;
        renderProductsTable();
        updateTotalAmount();
      }

      // æ›´æ–°å•†å“ä»·æ ¼
      function updateProductPrice(index, price) {
        const cost = parseFloat(price) || 0;
        selectedProducts[index].cost_price = cost;
        selectedProducts[index].amount =
          selectedProducts[index].quantity * cost;
        renderProductsTable();
        updateTotalAmount();
      }

      // ç§»é™¤å•†å“
      function removeProduct(index) {
        selectedProducts.splice(index, 1);
        renderProductsTable();
        updateTotalAmount();
        renderProductsList(); // åˆ·æ–°åˆ—è¡¨ï¼Œæ¢å¤å·²ç§»é™¤å•†å“
      }

      // æ›´æ–°æ€»é‡‘é¢
      function updateTotalAmount() {
        const total = selectedProducts.reduce(
          (sum, product) => sum + product.amount,
          0
        );
        document.getElementById("totalAmount").textContent = `ï¿¥${total.toFixed(
          2
        )}`;
      }

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      function showSuccess(message) {
        alert(message); // ç®€å•å®ç°ï¼Œå¯ä»¥åç»­ä¼˜åŒ–ä¸ºè‡ªå®šä¹‰æç¤ºæ¡†
      }

      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      function showError(message) {
        alert(message); // ç®€å•å®ç°ï¼Œå¯ä»¥åç»­ä¼˜åŒ–ä¸ºè‡ªå®šä¹‰æç¤ºæ¡†
      }
    </script>
  </body>
</html>
